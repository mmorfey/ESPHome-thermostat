# This project implements an advanced thermostat based on the Wemos D1 mini microcontroller (ESP8266)
# and the OpenTherm protocol to control the Bosch Gaz 6000 W gas boiler

esphome:
  name: diyless-thermostat
  friendly_name: DIYLESS Thermostat

esp8266:
  board: d1_mini

# Enable logging
logger:
  level: INFO
  on_message:
      - level: WARN
        then:
          - if:
              condition:
                # –®—É–∫–∞—î–º–æ "timeout" —É —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ª–æ–∑—ñ
                lambda: 'return std::string(message).find("timeout") != std::string::npos;'
              then:
                # 1. –ó–∞–ø–∏—Å—É—î–º–æ —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏ –≤ –Ω–∞—à —Ç–µ–∫—Å—Ç–æ–≤–∏–π —Å–µ–Ω—Å–æ—Ä
                - text_sensor.template.publish:
                    id: last_timeout_msg
                    state: !lambda 'return message;'
                # 2. –ù–∞–¥—Å–∏–ª–∞—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ HA
                - homeassistant.service:
                    service: persistent_notification.create
                    data:
                      title: "ESPHome Timeout"
                      message: !lambda 'return message;'

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key
    
# Enable Over-The-Air (OTA) platform to remotely install modified/updated firmware
ota:
  - platform: esphome

# Enable debug sensors
debug:

# WiFi settings
wifi:
  fast_connect: true
  power_save_mode: NONE
  reboot_timeout: 0s
  output_power: 8.5dB # –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è –≤—ñ–¥—Å—Ç–∞–Ω—ñ 1 –º–µ—Ç—Ä
  post_connect_roaming: true # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ —Å–∏–ª—å–Ω—ñ—à–∏–π AP

  networks:
    - ssid: !secret iot_wifi_ssid
      password: ""
      priority: 10

    - ssid: !secret main_wifi_ssid
      password: !secret wifi_password
      priority: 1

  manual_ip:
    static_ip: 192.168.0.112
    gateway: 192.168.0.1
    subnet: 255.255.255.0
    dns1: 192.168.0.1
    dns2: 8.8.8.8 # –†–µ–∑–µ—Ä–≤–Ω–∏–π DNS –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ–≥–æ —á–∞—Å—É (NTP)

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "DIYLESS Thermostat"
    password: ""

# Enable captive portal as fallback mechanism for when connecting to the configured WiFi fails.
captive_portal:

# Enable simple web server to remotelly control the device using web interface
web_server:  
  version: 3
  local: true
  include_internal: false
  #css_url: "https://oi.esphome.io/v1/webserver-v3.min.css"
  #css_include: "/config/esphome/style.css"
  sorting_groups:
    - id: group_status
      name: "üõ∞Ô∏è –°—Ç–∞—Ç—É—Å ESPHome"
      sorting_weight: 1
    - id: group_heating
      name: "üî• –û–ø–∞–ª–µ–Ω–Ω—è"
      sorting_weight: 2
    - id: group_temperature
      name: "üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ñ –¥–∞—Ç—á–∏–∫–∏"
      sorting_weight: 3
    - id: group_calculation
      name: "üßÆ –†–æ–∑—Ä–∞—Ö—É–Ω–∫–∏"
      sorting_weight: 4
    - id: group_dhw
      name: "üöø –ì–∞—Ä—è—á–∞ –≤–æ–¥–∞"
      sorting_weight: 20
    - id: group_wifi
      name: "üõú Wi-Fi"
      sorting_weight: 30
    - id: group_system_info
      name: "‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è"
      sorting_weight: 40
    - id: group_system_fault
      name: "‚ùå –ü–æ–º–∏–ª–∫–∏"
      sorting_weight: 50  

# Enable OpenTherm communication
# https://esphome.io/components/opentherm.html
opentherm:
  in_pin: 4 # WeMos D1 Mini ESP32 input pin for stacking with Master OpenTherm Shield
  out_pin: 5 # WeMos D1 Mini ESP32 output pin for stacking with Master OpenTherm Shield
  sync_mode: true # –ë–ª–æ–∫—É—î —Ü–∏–∫–ª –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ–±–º—ñ–Ω—É –¥–∞–Ω–∏–º–∏, —É—Å—É–≤–∞—é—á–∏ —Ç–∞–π–º–∞—É—Ç–∏
          
# Enable BME280 connection
i2c:
  sda: D3
  scl: D4
  scan: true

globals:
  - id: temp_source
    type: int
    restore_value: true
    initial_value: '0'   # 0=NONE, 1=HA, 2=BME

  - id: ha_stable_since
    type: uint32_t
    restore_value: false
    initial_value: '0'

  - id: cooling_rate
    type: float
    restore_value: true
    initial_value: '0.3' # –®–≤–∏–¥–∫—ñ—Å—Ç—å –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è (¬∞C / –≥–æ–¥)
  - id: heating_rate
    type: float
    restore_value: true
    initial_value: '0.5' # –®–≤–∏–¥–∫—ñ—Å—Ç—å –Ω–∞–≥—Ä—ñ–≤—É (¬∞C / –≥–æ–¥)
  - id: eco_offset
    type: float
    restore_value: false
    initial_value: '0.0'

  - id: temp_sample_start
    type: float
    restore_value: false
  - id: sample_time_start
    type: uint32_t
    restore_value: false


time:
  - platform: sntp
    id: sntp_time
    timezone: "Europe/Kyiv" # –í–∫–∞–∂—ñ—Ç—å –≤–∞—à —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å

#one_wire:
#  - platform: gpio
#    pin: D5

# Use switches to enable/disable central heating and hot water from HA interface
# https://esphome.io/components/opentherm.html#switch
switch:
  - platform: restart
    name: "Thermostat restart"
    web_server:
        sorting_group_id: group_status

  # –í–Ü–†–¢–£–ê–õ–¨–ù–ò–ô –ü–ï–†–ï–ú–ò–ö–ê–ß (–ü–£–°–¢–£–ù–ö–ê)
  - platform: template
    name: "Use Heating Curve"
    id: use_curve_logic
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:weather-partly-cloudy"
    # –î–æ–¥–∞—î–º–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è:
    on_turn_on:
      - lambda: |-
          ESP_LOGI("custom", "User ENABLED Heating Curve logic. Max water temp is now dynamic.");
    on_turn_off:
      - lambda: |-
          ESP_LOGI("custom", "User DISABLED Heating Curve logic. System back to pure PID control.");

  - platform: opentherm
    ch_enable:
      id: ch_enable
      name: "Heating"
      icon: mdi:radiator
      restore_mode: RESTORE_DEFAULT_OFF
      internal: false
      web_server:
        sorting_group_id: group_heating
    dhw_enable:
      id: dhw_enable
      name: "Hot Water"
      icon: mdi:water-thermometer-outline
      restore_mode: RESTORE_DEFAULT_OFF
      web_server:
        sorting_group_id: group_dhw

#    otc_active:
#      id: otc_active
#      name: "OTC Active" # –î–æ–∑–≤–æ–ª—è—î –≤–º–∏–∫–∞—Ç–∏/–≤–∏–º–∏–∫–∞—Ç–∏ –ø–æ–≥–æ–¥–æ–∑–∞–ª–µ–∂–Ω–∏–π —Ä–µ–∂–∏–º

# Use outputs to control numerical values like Central Heating setpoint using some automatic algorithms
output:
  - platform: opentherm
    t_set:
      id: ch_setpoint
      min_value: 40
      max_value: 80
      zero_means_zero: true

# Use numbers to control numerical values like CH/DHW setpoint from HA interface
# https://esphome.io/components/opentherm.html#numerical-values 
number:
  - platform: opentherm
#    t_set:
#      id: ch_setpoint
#      name: "Heating Setpoint"
#      step: 1
#      min_value: 30
#      max_value: 80
#      restore_value: true
#      initial_value: 60
    t_dhw_set:
      id: dhw_setpoint
      name: "How Water Setpoint"
      icon: mdi:water-check-outline
      step: 1
      min_value: 40
      max_value: 65
      restore_value: true
      initial_value: 60
      web_server:
        sorting_group_id: group_dhw
#    max_t_set:
#      id: ch_max_temp_limit
#      name: "–ú–∞–∫—Å. –ª—ñ–º—ñ—Ç —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è"
#      step: 1
#      min_value: 40  # –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –º—ñ–Ω—ñ–º—É–º Bosch Gaz 6000 W
#      max_value: 82  # –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –º–∞–∫—Å–∏–º—É–º Bosch Gaz 6000 W
#      restore_value: true
#      initial_value: 60

  - platform: template
    name: "–ë—É–¥–∏–Ω–æ–∫: –®–≤–∏–¥–∫—ñ—Å—Ç—å –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è"
    id: cooling_rate_ui
    min_value: 0.0
    max_value: 2.0
    step: 0.01
    unit_of_measurement: "¬∞C/–≥–æ–¥"
    icon: "mdi:snowflake-thermometer"
    restore_value: true # –ó–±–µ—Ä—ñ–≥–∞—î –≤–≤–µ–¥–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –ø–∞–º'—è—Ç—ñ ESP
    optimistic: true
    web_server:
        sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(cooling_rate) = x;' # –û–Ω–æ–≤–ª—é—î –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É –ø—Ä–∏ —Ä—É—á–Ω–æ–º—É –≤–≤–µ–¥–µ–Ω–Ω—ñ

  - platform: template
    name: "–ë—É–¥–∏–Ω–æ–∫: –®–≤–∏–¥–∫—ñ—Å—Ç—å –Ω–∞–≥—Ä—ñ–≤—É"
    id: heating_rate_ui
    min_value: 0.0
    max_value: 3.0
    step: 0.01
    unit_of_measurement: "¬∞C/–≥–æ–¥"
    icon: "mdi:sun-thermometer-outline"
    restore_value: true
    optimistic: true
    web_server:
        sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(heating_rate) = x;'

  - platform: template
    name: "–ë—É–¥–∏–Ω–æ–∫: –ï–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è"
    id: eco_offset_ui
    min_value: 0.0
    max_value: 1.5
    step: 0.1
    unit_of_measurement: "¬∞C"
    icon: "mdi:leaf"
    restore_value: true # –î–æ–∑–≤–æ–ª—è—î ESP "–∑–∞–ø–∞–º'—è—Ç–∞—Ç–∏" —Ü–∏—Ñ—Ä—É –ø—ñ—Å–ª—è —Ä–µ–±—É—Ç—É
    optimistic: true
    web_server:
      sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(eco_offset) = x;' # –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î –≤–≤–µ–¥–µ–Ω–µ —á–∏—Å–ª–æ –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ—é –∑–º—ñ–Ω–Ω–æ—é

# Use binary sensors (on/off) to monitor the states and conditions of different boiler entities.
# https://esphome.io/components/opentherm.html#binary-sensor
binary_sensor:
  # 1. –û—Ç—Ä–∏–º—É—î–º–æ —Å–∏–≥–Ω–∞–ª "–Ω—ñ—á" (–Ω–∞–ª–∞—à—Ç–æ–≤—É—î—Ç—å—Å—è –≤ HA –∑–∞ —á–∞—Å–æ–º)
  - platform: template
    id: night_mode
    icon: mdi:weather-night
    name: "Night Mode (Scheduled)"
    # –õ–æ–≥—ñ–∫–∞: —É–≤—ñ–º–∫–Ω–µ–Ω–æ –∑ 23:00 –¥–æ 07:00
    lambda: |-
      auto time = id(sntp_time).now();
      if (!time.is_valid()) return false; // –Ø–∫—â–æ —á–∞—Å –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ, —Ä–µ–∂–∏–º –≤–∏–º–∫–Ω–µ–Ω–æ
      return (time.hour >= 23 || time.hour < 7);
    # –¶–µ –≤–∞–∂–ª–∏–≤–æ: —Ç—Ä–∏–≥–µ—Ä–∏ –¥–ª—è –∑–∞–ø—É—Å–∫—É —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤ –º–∞—é—Ç—å –∑–∞–ª–∏—à–∏—Ç–∏—Å—è
    on_press:
      - script.execute: measure_cooling
      - script.execute: calculate_eco

# Gas counter
#  - platform: gpio
#    pin:
#      number: D3
#      mode: INPUT_PULLUP
#      inverted: True
#    name: gas_counter
#    filters:
#      - delayed_on: 10 ms
#      - delayed_off: 10 ms

  - platform: status
    name: "Status"
    icon: mdi:home-automation
    id: thermostat_status
    web_server:
        sorting_group_id: group_status

  - platform: opentherm
    ch_active:
      id: ch_active
      name: "Heating Active"
      web_server:
        sorting_group_id: group_heating
    dhw_active:
      id: dhw_active
      name: "Hot Water Active"
      web_server:
        sorting_group_id: group_dhw
      
    flame_on:
      id: flame_on
      name: "Flame On"
      web_server:
        sorting_group_id: group_heating

# Diagnostic
    # –ó–∞–≥–∞–ª—å–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—ñ: –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –ø—Ä–∏ –±—É–¥—å-—è–∫—ñ–π –∫—Ä–∏—Ç–∏—á–Ω—ñ–π –ø–æ–º–∏–ª—Ü—ñ –∫–æ—Ç–ª–∞
    fault_indication:
      id: fault_indication
      name: "Boiler Fault"
      icon: "mdi:alert-octagon" # –Ü–∫–æ–Ω–∫–∞ –∑—É–ø–∏–Ω–∫–∏/—Ç—Ä–∏–≤–æ–≥–∏
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # –î—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∞ –ø–æ–¥—ñ—è: —Å–∏–≥–Ω–∞–ª—ñ–∑—É—î –ø—Ä–æ —Å–µ—Ä–≤—ñ—Å–Ω—É –ø–æ–¥—ñ—é, —â–æ –ø–æ—Ç—Ä–µ–±—É—î –∞–Ω–∞–ª—ñ–∑—É
    diagnostic_indication:
      id: diagnostic_indication
      name: "Boiler Diagnostic"
      icon: "mdi:magnify-scan" # –°–∏–º–≤–æ–ª –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–∞ –ø–æ—à—É–∫—É
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # –ó–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤—ñ—Å: –≤–∫–∞–∑—É—î –Ω–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –ø–ª–∞–Ω–æ–≤–æ–≥–æ –¢–û
    service_request:
      name: "Service Required"
      icon: "mdi:hammer-wrench" # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Å–∏–º–≤–æ–ª —Å–µ—Ä–≤—ñ—Å—É Bosch
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # –°—Ç–∞–Ω –±–ª–æ–∫—É–≤–∞–Ω–Ω—è: –∫–æ—Ç–µ–ª –ø–æ—Ç—Ä–µ–±—É—î –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "Reset"
    lockout_reset:
      name: "Lockout Reset"
      icon: "mdi:lock-reset" # –°–∏–º–≤–æ–ª –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Ç–∞ —Å–∫–∏–¥–∞–Ω–Ω—è
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # –ù–∏–∑—å–∫–∏–π —Ç–∏—Å–∫ –≤–æ–¥–∏: –ø–æ–º–∏–ª–∫–∞ CE —É –≤–∞—à–æ–º—É –∫–æ—Ç–ª—ñ
    low_water_pressure:
      name: "Low Water Pressure Fault"
      icon: "mdi:gauge-low" # –°–∏–º–≤–æ–ª –Ω–∏–∑—å–∫–æ–≥–æ —Ç–∏—Å–∫—É –Ω–∞ –º–∞–Ω–æ–º–µ—Ç—Ä—ñ
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # –ü–æ–º–∏–ª–∫–∞ –ø–æ–ª—É–º'—è: –ø—Ä–æ–±–ª–µ–º–∏ –∑ —Ä–æ–∑–ø–∞–ª–æ–º (–ø–æ–º–∏–ª–∫–∞ EA –∞–±–æ FA)
    flame_fault:
      name: "Flame Fault"
      icon: "mdi:fire-off" # –°–∏–º–≤–æ–ª –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –ø–æ–ª—É–º'—è
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # –ü–æ–º–∏–ª–∫–∞ —Ç–∏—Å–∫—É –ø–æ–≤—ñ—Ç—Ä—è: –ø—Ä–æ–±–ª–µ–º–∏ –∑ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º –∞–±–æ –¥–∏–º–æ—Ö–æ–¥–æ–º (–ø–æ–º–∏–ª–∫–∏ C1‚ÄìC7)
    air_pressure_fault:
      name: "Air Pressure Fault"
      icon: "mdi:fan-alert" # –°–∏–º–≤–æ–ª –Ω–µ—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—ñ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # –ü–µ—Ä–µ–≥—Ä—ñ–≤ –≤–æ–¥–∏: —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è –æ–±–º–µ–∂—É–≤–∞—á–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ (–ø–æ–º–∏–ª–∫–∞ E9)
    water_over_temp:
      name: "Water Overtemperature"
      icon: "mdi:thermometer-alert" # –°–∏–º–≤–æ–ª –∫—Ä–∏—Ç–∏—á–Ω–æ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏
      entity_category: diagnostic 
      web_server:
        sorting_group_id: group_system_fault

sensor:
  - platform: wifi_signal
    id: wifi_signal_dbm
    name: "WiFi Signal dBm"
    icon: mdi:signal-distance-variant
    web_server:
        sorting_group_id: group_wifi
    update_interval: 30s

  - platform: template
    name: "WiFi Signal %"
    web_server:
        sorting_group_id: group_wifi
    unit_of_measurement: "%"
    icon: mdi:wifi-star
    lambda: |-
      if (id(wifi_signal_dbm).state <= -100) {
        return 0;
      } else if (id(wifi_signal_dbm).state >= -50) {
        return 100;
      } else {
        return 2 * (id(wifi_signal_dbm).state + 100);
      }
    update_interval: 30s

# Approximate calculation of gas consumption based on modulation
  - platform: template
    name: "Estimated Gas Flow"
    id: gas_flow_rate
    icon: mdi:meter-gas-outline
    unit_of_measurement: "m¬≥/h"
    accuracy_decimals: 3
    lambda: |-
      if (id(flame_on).state) {
        float modulation = id(rel_mod_level).state / 100.0;
        // 2.1 - –º–∞–∫—Å. –≤–∏—Ç—Ä–∞—Ç–∞, 0.624 - –º—ñ–Ω. –≤–∏—Ç—Ä–∞—Ç–∞ –ø—Ä–∏ –º—ñ–Ω. —Å—Ç–∞–±—ñ–ª—å–Ω–æ–º—É –ø–æ–ª—É–º'—ó (18–∫–í—Ç –º–æ–¥–µ–ª—å)
        return 0.624 + (modulation * (2.1 - 0.624));
      }
      return 0.0;
    update_interval: 2s
    web_server:
        sorting_group_id: group_calculation

  - platform: debug
    free:
      name: "Free RAM, bytes"
      id: free_ram
      icon: mdi:memory
      unit_of_measurement: "bytes"
      web_server:
        sorting_group_id: group_status
    
    loop_time:
      name: "Loop time, ms"
      id: loop_time
      unit_of_measurement: "ms"
      web_server:
        sorting_group_id: group_status

  - platform: template
    name: "Free RAM, %"
    unit_of_measurement: "%"
    icon: mdi:memory
    accuracy_decimals: 1
    lambda: |-
      // –î–ª—è ESP8266 –∑ –≤–∞—à–∏–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º 45000 –±–∞–π—Ç ‚Äî —Ü–µ —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π –º–∞–∫—Å–∏–º—É–º
      float percentage = (id(free_ram).state / 45000.0) * 100.0;
      if (percentage > 100.0) percentage = 100.0;
      return percentage;
    web_server:
      sorting_group_id: group_status

  - platform: homeassistant
    entity_id: sensor.in_temperature 
    name: "–í–Ω—É—Ç—Ä—ñ—à–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (HA)"
    id: in_temp_from_ha
    icon: mdi:home-thermometer
    internal: true 
    unit_of_measurement: "¬∞C" 
    device_class: temperature
    filters:
      # Push room temperature every second to update PID parameters
      - heartbeat: 5s
    web_server:
        sorting_group_id: group_temperature

  - platform: homeassistant
    entity_id: sensor.external_weather_temp_sensor
    id: t_outside_ha
    icon: mdi:home-thermometer-outline
    internal: true
    name: "–í—É–ª–∏—á–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (HA)"
    unit_of_measurement: "¬∞C"
    device_class: temperature
    web_server:
        sorting_group_id: group_temperature

  - platform: uptime
    name: "Uptime seconds"
    id: uptime_sec
    web_server:
        sorting_group_id: group_status

# OpenTherm sensors
# https://esphome.io/components/opentherm.html#sensor
  - platform: opentherm
    t_boiler:
      id: ch_temperature
      name: "Heating Temperature"
      icon: mdi:thermometer
      web_server:
        sorting_group_id: group_heating # –ü—Ä–∏–≤'—è–∑–∫–∞ –¥–æ –≥—Ä—É–ø–∏
    t_dhw:
      id: dhw_temperature
      name: "Hot Water Temperature"
      icon: mdi:water-thermometer-outline
      web_server:
        sorting_group_id: group_dhw
    rel_mod_level:
      id: rel_mod_level
      name: "Boiler Relative Modulation Level"
      web_server:
        sorting_group_id: group_heating
#    t_outside:
#      name: Outside Temperature
#    t_ret:
#      name: Return Water Temperature
#    max_t_set:
#      name: CH Setpoint Max    
#      web_server:
#        sorting_group_id: group_heating
#    max_t_set_ub:
#      name: CH Setpoint Upper Bound   
#    max_t_set_lb:  
#      name: CH Setpoint Lower Bound
#    t_exhaust:    
#      name: Boiler Exhaust Temperature
#      entity_category: diagnostic
    # –ö–æ–¥–∏ –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (—á–∏—Å–ª–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥ –≤–∏—Ä–æ–±–Ω–∏–∫–∞)
    oem_fault_code:
      name: "OEM Fault Code"
      icon: "mdi:tumble-dryer-alert" # –í–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ —Ü–µ —á–∏—Å–ª–æ–≤–∏–π –∫–æ–¥ –ø–æ–º–∏–ª–∫–∏
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    oem_diagnostic_code:
      name: "OEM Diagnostic Code"
      icon: "mdi:water-boiler-alert" # –ß–∏—Å–ª–æ–≤–∏–π –∫–æ–¥ –¥–ª—è —Ç–µ—Ö–Ω—ñ—á–Ω–æ—ó –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    # –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—é (–ø–∞—Å–ø–æ—Ä—Ç –ø—Ä–∏—Å—Ç—Ä–æ—é)
    device_id:
      name: "Boiler Device ID"
      icon: "mdi:identifier" # –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø—Ä–∏—Å—Ç—Ä–æ—é
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info
      
    device_type:
      name: "Boiler Device Type"
      icon: "mdi:format-list-bulleted-type" # –¢–∏–ø –∞–±–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    device_version:
      name: "Boiler Device Version"
      icon: "mdi:label-variant-outline" # –í–µ—Ä—Å—ñ—è ¬´–∑–∞–ª—ñ–∑–∞¬ª –∞–±–æ –ø—Ä–æ—à–∏–≤–∫–∏ –∫–æ—Ç–ª–∞
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    # –¢–µ—Ö–Ω—ñ—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—Ä–æ—Ç–æ–∫–æ–ª –∑–≤'—è–∑–∫—É
    opentherm_version_device:
      name: "Boiler OpenTherm Version"
      icon: "mdi:network-outline" # –í–µ—Ä—Å—ñ—è –ø—Ä–æ—Ç–æ–∫–æ–ª—É OpenTherm, —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –≤ –∫–æ—Ç–ª—ñ
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    # 1.6d: –ü–æ—Ç–æ—á–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å –ø—Ä–æ—Ç–æ–∫—É –≤–æ–¥–∏ —á–µ—Ä–µ–∑ —Ç—É—Ä–±—ñ–Ω—É (–ª/—Ö–≤)
    # –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É OpenTherm ID 19
    dhw_flow_rate:
      name: "Water Flow Rate"
      id: boiler_flow_rate
      accuracy_decimals: 1
      icon: "mdi:water-pump"
      web_server:
        sorting_group_id: group_dhw

    # 2.9b: –ü–æ—Ç–æ—á–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞
    # –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É OpenTherm ID 121
    fan_speed:
      name: "Fan Speed"
      id: boiler_fan_speed
      accuracy_decimals: 0
      icon: "mdi:fan"
      web_server:
        sorting_group_id: group_heating

# Checking data availability from HA and, if not, switching to the internal sensor
  - platform: template
    id: smart_room_temperature
    name: "Smart Room Temperature"
    icon: mdi:thermometer-auto
    unit_of_measurement: "¬∞C"
    device_class: "temperature"
    state_class: "measurement"
    accuracy_decimals: 2
    update_interval: 2s
    web_server:
        sorting_group_id: group_heating
    lambda: |-
      int new_source = 0;
      const uint32_t HA_STABLE_TIME = 10000; // 10 —Å–µ–∫—É–Ω–¥ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ

      // --- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ HA ---
      if (id(thermostat_status).state &&
          id(in_temp_from_ha).has_state() &&
          isfinite(id(in_temp_from_ha).state)) {
          
        if (id(ha_stable_since) == 0) {
          id(ha_stable_since) = millis();
        }

        if (millis() - id(ha_stable_since) >= HA_STABLE_TIME) {
          new_source = 1; // HA
        }

      } else {
        id(ha_stable_since) = 0;
      }

      // --- Fallback –Ω–∞ BME ---
      if (new_source == 0 &&
          id(bme280_temperature).has_state() &&
          isfinite(id(bme280_temperature).state)) {
        new_source = 2; // BME
      }

      // --- –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ—Ö–æ–¥—ñ–≤ ---
      if (new_source != id(temp_source)) {
        if (new_source == 1) {
          ESP_LOGI("temp", "Temperature source switched to HOME ASSISTANT");
        } else if (new_source == 2) {
          ESP_LOGW("temp", "Temperature source switched to BME280");
        } else {
          ESP_LOGE("temp", "No valid temperature source available");
        }
        id(temp_source) = new_source;
      }

      // --- –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω–Ω—è ---
      float result = NAN; // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–º—ñ–Ω–Ω—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
      if (new_source == 1) {
        result = id(in_temp_from_ha).state;
      } else if (new_source == 2) {
        result = id(bme280_temperature).state;
      }

      // --- –î–û–î–ê–¢–ò –¶–ï–ô –ë–õ–û–ö (–ê–¥–∞–ø—Ç–∏–≤–Ω–µ –ï–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è) --- [1]
      if (id(night_mode).state && !std::isnan(result)) {
        result += id(eco_offset); // PID "–¥—É–º–∞—î", —â–æ –≤ —Ö–∞—Ç—ñ —Ç–µ–ø–ª—ñ—à–µ, —ñ –º'—è–∫–æ –∑–Ω–∏–∂—É—î –Ω–∞–≥—Ä—ñ–≤
      }
      
      return result;

  - platform: template
    name: "Equithermic Target Temperature"
    id: equitherm_t_set
    unit_of_measurement: "¬∞C"
    icon: "mdi:chart-bell-curve-cumulative"
    lambda: |-
      float to = id(t_outside_ha).state; // –í—É–ª–∏—á–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
      float tr = id(pid_calculated_target).state; // –¶—ñ–ª—å–æ–≤–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –∫—ñ–º–Ω–∞—Ç—ñ
      // float k = 1.2;   // –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –∫—Ä–∏–≤–æ—ó (–º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –≤ globals)
      // --- –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø–æ–≥–æ–¥–Ω–æ—ó –∫—Ä–∏–≤–æ—ó ---
      float k;
      if (to <= -10.0)      k = 1.30;
      else if (to <= 0.0)   k = 1.15;
      else if (to <= 5.0)   k = 1.00;
      else                  k = 0.85;

      if (std::isnan(to)) return 50.0; // Fallback: —è–∫—â–æ HA –Ω–µ –ø–µ—Ä–µ–¥–∞–≤ –¥–∞–Ω—ñ, —Å—Ç–∞–≤–∏–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ 40¬∞C

      // –ö–ª–∞—Å–∏—á–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –æ–ø–∞–ª—é–≤–∞–ª—å–Ω–æ—ó –∫—Ä–∏–≤–æ—ó
      float t_water = tr + k * (tr - to); 

      // –û–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è Bosch Gaz 6000 W (–¥—ñ–∞–ø–∞–∑–æ–Ω 40-82¬∞C)
      if (t_water > 80.0) t_water = 80.0;
      if (t_water < 40.0) t_water = 40.0;

      return t_water;
    update_interval: 60s

  # Adding a BME280 sensor
  - platform: bme280_i2c
    temperature:
      name: "BME280 Temperature"
      id: bme280_temperature
      icon: mdi:thermometer
      web_server:
        sorting_group_id: group_temperature
    pressure:
      name: "BME280 Pressure"
      id: bme280_pressure
      icon: mdi:gauge
      web_server:
        sorting_group_id: group_temperature
    humidity:
      name: "BME280 Humidity"
      id: bme280_humidity
      icon: mdi:water-percent
      web_server:
        sorting_group_id: group_temperature
    address: 0x76
    update_interval: 30s

  - platform: template
    name: "–¶—ñ–ª—å–æ–≤–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è (PID)"
    id: pid_calculated_target
    unit_of_measurement: "¬∞C"
    accuracy_decimals: 1
    web_server:
        sorting_group_id: group_heating
    icon: "mdi:thermometer-lines"
    lambda: |-
      // –û—Å–∫—ñ–ª—å–∫–∏ ch_setpoint —É–∂–µ –ø–æ–≤–µ—Ä—Ç–∞—î –≥—Ä–∞–¥—É—Å–∏, –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º–æ –π–æ–≥–æ —Å—Ç–∞–Ω
      float target = id(ch_setpoint).state;
      
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤–∏–º–∫–Ω–µ–Ω–∏–π —Å—Ç–∞–Ω (—è–∫—â–æ zero_means_zero: true)
      if (target <= 0.0) return 0.0;
      
      return target;
    update_interval: 10s

  - platform: template
    name: "–í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏"
    id: temp_deviation
    unit_of_measurement: "¬∞C"
    accuracy_decimals: 2
    web_server:
        sorting_group_id: group_heating
    icon: mdi:delta
    lambda: |-
      // –û—Ç—Ä–∏–º—É—î–º–æ —Ü—ñ–ª—å–æ–≤—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑ –∫–ª—ñ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞
      float target = id(ch_climate).target_temperature;
      
      // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑ –≤–∞—à–æ–≥–æ "—Ä–æ–∑—É–º–Ω–æ–≥–æ" —Å–µ–Ω—Å–æ—Ä–∞
      float current = id(smart_room_temperature).state;
      
      // –Ø–∫—â–æ –¥–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ NAN
      if (std::isnan(current) || std::isnan(target)) {
        return NAN;
      }
      
      // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —Ä—ñ–∑–Ω–∏—Ü—é
      return target - current;
    update_interval: 5s

text_sensor:
  - platform: template
    name: "Last Timeout Message"
    icon: mdi:math-log
    id: last_timeout_msg

  - platform: template
    name: "–ë—É–¥–∏–Ω–æ–∫: –°—Ç–∞—Ç—É—Å —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤"
    id: calculation_status
    icon: mdi:database-sync-outline
    web_server:
      sorting_group_id: group_calculation

  - platform: template
    name: "Loop time state"
    icon: mdi:speedometer
    lambda: |-
      float val = id(loop_time).state;
      if (val < 10.0) return {"Fast"};
      if (val < 50.0) return {"Normal"};
      if (val < 100.0) return {"Long"};
      if (val < 200.0) return {"Too Long"};
      return {"Critical"};
    update_interval: 10s
    web_server:
      sorting_group_id: group_status

  # Thermostat operating time since last reset
  - platform: template
    name: "Uptime"
    icon: mdi:clock-outline
    entity_category: diagnostic
    update_interval: 10s
    web_server:
      sorting_group_id: group_status
    lambda: |-
      uint32_t s = (uint32_t) id(uptime_sec).state;

      uint32_t days = s / 86400;
      uint32_t hours = (s % 86400) / 3600;
      uint32_t minutes = (s % 3600) / 60;
      uint32_t seconds = s % 60;

      char buffer[32];
      snprintf(buffer, sizeof(buffer),
               "%lu –¥–Ω. %02lu:%02lu:%02lu",
               days, hours, minutes, seconds);
      return std::string(buffer);

  - platform: wifi_info
    ssid:
      name: "WiFi SSID"
      icon: mdi:wifi-check
      web_server:
        sorting_group_id: group_wifi
    ip_address:
      name: "WiFi IP Address"
      icon: mdi:wifi-settings
      web_server:
        sorting_group_id: group_wifi
    bssid:
      name: "WiFi BSSID"
      icon: mdi:wifi-cog
      web_server:
        sorting_group_id: group_wifi

# Use PID Climate component for automatic boiler setpoint calculation
# https://esphome.io/components/climate/pid
climate:
  - platform: pid
    id: ch_climate
    name: "Heating Climate"
    icon: mdi:thermostat-auto
    web_server:
      sorting_group_id: group_heating
    heat_output: ch_setpoint
    default_target_temperature: 21
    sensor: smart_room_temperature
    visual:
      min_temperature: 19
      max_temperature: 24
      temperature_step:
        target_temperature: 0.1
        current_temperature: 0.1
    control_parameters: 
      kp: 0.4
      ki: 0.002
      kd: 0
      output_averaging_samples: 60
    deadband_parameters:
      threshold_high: 0.5
      threshold_low: -0.3
      kp_multiplier: 0.4
      ki_multiplier: 0.15
      kd_multiplier: 0.0
      deadband_output_averaging_samples: 40
    on_state:
      - lambda: |-
          // 1. –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∂–∏–≤–ª–µ–Ω–Ω—è–º –∫–æ—Ç–ª–∞
          if (x.mode == CLIMATE_MODE_OFF) {
            id(ch_enable).turn_off();
          } else {
            id(ch_enable).turn_on();
            // –ó–ê–ü–£–°–ö–ê–¢–ò –¢–Ü–õ–¨–ö–ò –Ø–ö–©–û –°–ö–†–ò–ü–¢ –©–ï –ù–ï –ü–†–ê–¶–Æ–Ñ
            if (id(flame_on).state && !id(measure_heating).is_running()) {
              id(measure_heating).execute();
            }
          }

          // 2. –î–∏–Ω–∞–º—ñ—á–Ω–∏–π PID (–ú'—è–∫—à—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –≤–Ω–æ—á—ñ)
          if (id(night_mode).state) {
              // –ó–ê–ú–Ü–°–¢–¨ id(ch_climate).set_control_parameters(0.35, 0.001, 0.0);
              id(ch_climate).set_kp(0.35); 
              id(ch_climate).set_ki(0.001);
              id(ch_climate).set_kd(0.0);
          } else {
              // –ó–ê–ú–Ü–°–¢–¨ id(ch_climate).set_control_parameters(0.4, 0.002, 0.0);
              id(ch_climate).set_kp(0.45);
              id(ch_climate).set_ki(0.0015);
              id(ch_climate).set_kd(0.0);
          }

          // 3. –î–∏–Ω–∞–º—ñ—á–Ω–µ –æ–±–º–µ–∂–µ–Ω–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è
          float cap = id(equitherm_t_set).state; // –ë–µ—Ä–µ–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –ø–æ–≥–æ–¥–Ω–æ—ó –∫—Ä–∏–≤–æ—ó
          
          if (id(night_mode).state) {
            cap -= 8.0; // –í–Ω–æ—á—ñ –¥–æ–¥–∞—Ç–∫–æ–≤–æ –æ–±–º–µ–∂—É—î–º–æ –≤–æ–¥—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–µ –≤–∏—â–µ 45-48¬∞C)
          }
          
          // –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –º—ñ–Ω—ñ–º—É–º Bosch Gaz 6000 W
          if (cap < 40.0) cap = 40.0; 

          // –ü—Ä–∏–º—É—Å–æ–≤–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –≤–∏—Ö–æ–¥—É PID
          if (id(ch_setpoint).state > cap) {
            id(ch_setpoint).set_level(cap);
          }

          // 4. –õ–æ–≥—É–≤–∞–Ω–Ω—è
          ESP_LOGI("climate", "Target: %.1f, Water: %.1f %s", 
                   x.target_temperature, id(ch_setpoint).state,
                   id(night_mode).state ? "(NIGHT MODE)" : "");
          
#      - logger.log:
#          format: "climate mode=%s, t_target=%.1f, t_boiler_set=%.1f"
#          args: ['climate_mode_to_string(x.mode)', 'x.target_temperature', 'id(ch_setpoint).state' ]
#          level: INFO

script:
  # –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è (–∫–æ–ª–∏ –∫–æ—Ç–µ–ª –≤–∏–º–∫–Ω–µ–Ω–æ)
  - id: measure_cooling
    mode: restart
    then:
      - lambda: |-
          ESP_LOGI("eco", "–û—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è. –ü–æ—á–∞—Ç–æ–∫ –∑–∞–º—ñ—Ä—É —ñ–Ω–µ—Ä—Ü—ñ—ó (45 —Ö–≤)...");
          // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –û–î–†–ê–ó–£ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ:
          id(calculation_status).publish_state("–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è (—Ç—Ä–∏–≤–∞—î 45 —Ö–≤)");
          id(temp_sample_start) = id(smart_room_temperature).state;
          id(sample_time_start) = millis();
      - delay: 45min
      - lambda: |-
          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —è–∫—â–æ –∑–∞ —Ü–µ–π —á–∞—Å –∫–æ—Ç–µ–ª –≤–º–∏–∫–∞–≤—Å—è, –∑–∞–º—ñ—Ä –Ω–µ—Ç–æ—á–Ω–∏–π
          if (id(flame_on).state) {
            id(calculation_status).publish_state("–û—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ—Ä–≤–∞–Ω–æ (–≤–º–∏–∫–∞–≤—Å—è –∫–æ—Ç–µ–ª)");
            return;
          }

          float dt = (millis() - id(sample_time_start)) / 3600000.0;
          if (dt < 0.2) return;

          float rate = (id(temp_sample_start) - id(smart_room_temperature).state) / dt;

          if (rate > 0 && rate < 2.0) {
            id(cooling_rate) = id(cooling_rate) * 0.7 + rate * 0.3;
            id(calculation_status).publish_state("–û—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –≤–∏–º—ñ—Ä—è–Ω–æ —É—Å–ø—ñ—à–Ω–æ");
            id(cooling_rate_ui).publish_state(id(cooling_rate)); 
            ESP_LOGI("eco", "New cooling rate: %.2f ¬∞C/h", id(cooling_rate));
          } else {
            id(calculation_status).publish_state("–ó–∞–º—ñ—Ä –Ω–µ—Ç–æ—á–Ω–∏–π (–¢ –Ω–µ –≤–ø–∞–ª–∞)");
          }

  # --- –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –Ω–∞–≥—Ä—ñ–≤—É (—Ä–∞–Ω–æ–∫ / –∞–∫—Ç–∏–≤–Ω–µ –≥–æ—Ä—ñ–Ω–Ω—è) ---
  - id: measure_heating
    mode: restart
    then:
      - lambda: |-
          ESP_LOGI("eco", "–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –Ω–∞–≥—Ä—ñ–≤—É (—Å—Ç–∞—Ä—Ç)...");
          // –ü–æ–∫–∞–∑—É—î–º–æ –≤ –•–ê, —â–æ –ø—Ä–æ—Ü–µ—Å —ñ–¥–µ, –∞ –Ω–µ —â–æ –≤—ñ–Ω —É–∂–µ –ø–µ—Ä–µ—Ä–≤–∞–Ω–∏–π
          id(calculation_status).publish_state("–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –Ω–∞–≥—Ä—ñ–≤—É (—Ç—Ä–∏–≤–∞—î 30 —Ö–≤)");
          
          id(temp_sample_start) = id(smart_room_temperature).state;
          id(sample_time_start) = millis();
      - delay: 30min
      - lambda: |-
          // –¢—ñ–ª—å–∫–∏ –¢–£–¢ –º–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–∞–º—ñ—Ä –±—É–≤ —É—Å–ø—ñ—à–Ω–∏–º
          if (!id(flame_on).state || id(rel_mod_level).state < 20) {
            id(calculation_status).publish_state("–ù–∞–≥—Ä—ñ–≤ –ø–µ—Ä–µ—Ä–≤–∞–Ω–æ (–Ω–∏–∑—å–∫–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å)");
            return;
          }

          float dt = (millis() - id(sample_time_start)) / 3600000.0;
          if (dt < 0.2) return;

          float rate = (id(smart_room_temperature).state - id(temp_sample_start)) / dt;

          if (rate > 0 && rate <= 3.0) {
            id(heating_rate) = id(heating_rate) * 0.7 + rate * 0.3;
            id(calculation_status).publish_state("–ù–∞–≥—Ä—ñ–≤ –≤–∏–º—ñ—Ä—è–Ω–æ —É—Å–ø—ñ—à–Ω–æ");
            id(heating_rate_ui).publish_state(id(heating_rate));
            
            ESP_LOGI("eco", "New heating rate calculated: %.2f ¬∞C/h", id(heating_rate));
          } else {
            id(calculation_status).publish_state("–ó–∞–º—ñ—Ä –Ω–µ—Ç–æ—á–Ω–∏–π (–Ω–µ–º–∞—î —Ä–æ—Å—Ç—É –¢)");
          }

  # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–º—ñ—â–µ–Ω–Ω—è (offset) –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ–Ω–µ—Ä—Ü—ñ—ó
  - id: calculate_eco
    mode: restart
    then:
      - lambda: |-
          // –Ø–∫—â–æ –Ω—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º –≤–∏–º–∫–Ω–µ–Ω–æ, —Å–∫–∏–¥–∞—î–º–æ –∑–º—ñ—â–µ–Ω–Ω—è
          if (!id(night_mode).state) { 
            id(eco_offset) = 0.0;
            id(eco_offset_ui).publish_state(0.0);
            return; 
          }

          // –§–æ—Ä–º—É–ª–∞: —à–≤–∏–¥–∫—ñ—Å—Ç—å –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è * 8 –≥–æ–¥–∏–Ω –Ω–æ—á—ñ * –∫–æ–µ—Ñ. –∑–∞–ø–∞—Å—É 0.8
          float offset = id(cooling_rate) * 8.0 * 0.8; 

          // –û–±–º–µ–∂–µ–Ω–Ω—è (clamp), —â–æ–± –±—É–¥–∏–Ω–æ–∫ –Ω–µ –≤–∏—Ö–æ–ª–æ–¥–∏–≤—Å—è –±—ñ–ª—å—à–µ –Ω—ñ–∂ –Ω–∞ 1.5¬∞C
          id(eco_offset) = clamp(offset, 0.3f, 1.5f); 
          
          // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Home Assistant
          id(eco_offset_ui).publish_state(id(eco_offset));
          id(calculation_status).publish_state("–ï–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ");
          
          ESP_LOGI("eco", "Calculated adaptive offset: %.2f ¬∞C", id(eco_offset));