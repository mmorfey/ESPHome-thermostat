# [UA] –ü—Ä–æ—î–∫—Ç —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–∞ –Ω–∞ –±–∞–∑—ñ Wemos D1 mini (ESP8266)
# [UA] –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≥–∞–∑–æ–≤–∏–º –∫–æ—Ç–ª–æ–º Bosch Gaz 6000 W —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª OpenTherm
# [EN] Advanced thermostat project based on Wemos D1 mini (ESP8266)
# [EN] for controlling Bosch Gaz 6000 W gas boiler via OpenTherm protocol
# RAM free config
# - without web_server = avg 20kB
# - Add web_server v2 = avg 17kB
# - Change to web_server v3 = avg 15kB
# - Add category = avg 12kB

substitutions:
  # --- Eco mode limits ---
  ECO_OFFSET_MIN: "0.3f"
  ECO_OFFSET_MAX: "1.5f"
  ECO_OFFSET_DEFAULT: "1.0f"

  # --- Eco learning ---
  ECO_GAIN_INIT: "0.8f"
  ECO_GAIN_MIN: "0.6f"
  ECO_GAIN_MAX: "0.9f"
  ECO_GAIN_STEP: "0.05f"

  # --- Time tolerances ---
  NIGHT_TIME_TOLERANCE: "0.01f"   # ~36 seconds

  # --- Measurement windows ---
  COOLING_MEASURE_MINUTES: "45"
  HEATING_MEASURE_MINUTES: "30"

  # --- Measurement filters ---
  EMA_ALPHA: "0.7f"

  # --- Learning quality gate ---
  MIN_VALID_COOLING_RATE: "0.02f"   # ¬∞C/hour
  MIN_NIGHT_DURATION: "5.0f"        # hours

  # --- Boiler physical limits ---
  MIN_BOILER_TEMP: "42.0"
  MAX_BOILER_TEMP: "80.0"
  NIGHT_WATER_REDUCTION: "8.0f"
  
  # --- PID Day settings ---
  KP_DAY: "0.45f"
  KI_DAY: "0.0015f"
  
  # --- PID Night settings ---
  KP_NIGHT: "0.35f"
  KI_NIGHT: "0.001f"
  
  # --- Safety & Stability ---
  HA_STABLE_TIME_MS: "10000"
  MAX_PREHEAT_HOURS: "4.0f"

esphome:
  name: diyless-thermostat
  friendly_name: DIYLESS Thermostat
  on_boot:
    priority: -10 # [UA] –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –≤—Å—ñ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤
    then:
      - text_sensor.template.publish: { id: cooling_status, state: "Idle" }
      - text_sensor.template.publish: { id: heating_status, state: "Idle" }
      - text_sensor.template.publish: { id: learning_status, state: "Ready" }
      - text_sensor.template.publish: { id: eco_status, state: "Idle" }
      - text_sensor.template.publish: { id: preheat_status, state: "Idle" }

esp8266:
  board: d1_mini

# [UA] –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Ç–∞–π–º–∞—É—Ç—ñ–≤ OpenTherm
# [EN] Logging settings and automatic OpenTherm timeout tracking
logger:
#  level: INFO
#
#udp:
#  id: udp_graylog
#  addresses: 192.168.0.120
#
#syslog:
#  udp_id: udp_graylog
#  time_id: sntp_time
#  port: 1514
#  level: INFO

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key
  reboot_timeout: 0s
    
# Enable Over-The-Air (OTA) platform to remotely install modified/updated firmware
ota:
  - platform: esphome

# Enable debug sensors
debug:

# [UA] –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Wi-Fi –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Ä–æ—É–º—ñ–Ω–≥—É —Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –º–µ—Ä–µ–∂—ñ
# [EN] Wi-Fi settings with roaming support and backup network connectivity
wifi:
  fast_connect: true
  power_save_mode: NONE # [UA] –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è OpenTherm! [EN] Critical for OpenTherm!
  reboot_timeout: 0s # [UA] –ó–∞–ø–æ–±—ñ–≥–∞—î —Ä–µ–±—É—Ç—É –ø—Ä–∏ –∑–Ω–∏–∫–Ω–µ–Ω–Ω—ñ –º–µ—Ä–µ–∂—ñ. [EN] Prevents reboot on Wi-Fi loss
  output_power: 8.5dB # Optimized for a distance of 1 meter from the router
  post_connect_roaming: true # Automatic switching to a stronger signal

  networks:
    - ssid: !secret iot_wifi_ssid
      password: ""
      priority: 10

    - ssid: !secret main_wifi_ssid
      password: !secret wifi_password
      priority: 1

  manual_ip:
    static_ip: 192.168.0.112
    gateway: 192.168.0.1
    subnet: 255.255.255.0
    dns1: 192.168.0.1
    dns2: 8.8.8.8 # Backup DNS for stable time (NTP)

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  #ap:
  #  ssid: "DIYLESS Thermostat"
  #  password: ""

# Enable captive portal as fallback mechanism for when connecting to the configured WiFi fails.
#captive_portal:

# Enable simple web server to remotelly control the device using web interface
#web_server:
#  version: 2
#  local: true
#  include_internal: false
#  sorting_groups:
#    - id: group_status
#      name: "üõ∞Ô∏è Main status"
#      sorting_weight: 1
#    - id: group_heating
#      name: "üî• Heating"
#      sorting_weight: 2
#    - id: group_temperature
#      name: "üå°Ô∏è Temperature sensors"
#      sorting_weight: 3
#    - id: group_calculation
#      name: "üßÆ Calculations"
#      sorting_weight: 4
#    - id: group_dhw
#      name: "üöø Hot water"
#      sorting_weight: 20
#    - id: group_wifi
#      name: "üõú Wi-Fi"
#      sorting_weight: 30
#    - id: group_system_info
#      name: "‚öôÔ∏è System info"
#      sorting_weight: 40
#    - id: group_boiler_faults
#      name: "‚ùå Boiler Faults"
#      sorting_weight: 50  

# Enable OpenTherm communication
# https://esphome.io/components/opentherm.html
# [UA] –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∏–Ω–∏ OpenTherm. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ø—ñ–Ω–∏ D1 —Ç–∞ D2
# [EN] OpenTherm hub setup. Pins D1 and D2 are used
opentherm:
  in_pin: 4 # WeMos D1 Mini ESP32 input pin for stacking with Master OpenTherm Shield
  out_pin: 5 # WeMos D1 Mini ESP32 output pin for stacking with Master OpenTherm Shield
  # [UA] sync_mode: true —É—Å—É–≤–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω—å –ø—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ —ñ–Ω—à–∏—Ö –¥–∞—Ç—á–∏–∫—ñ–≤
  # [EN] sync_mode: true eliminates interrupt conflicts when using other sensors
  sync_mode: false

# Enable BME280 connection
# [UA] –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è I2C —à–∏–Ω–∏, –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ D6/D7 –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
# [EN] I2C bus configuration, moved to D6/D7 for hardware stability
i2c:
  sda: D6
  scl: D7
  scan: true

# [UA] –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ - "–¢–µ—Ö–Ω—ñ—á–Ω–∏–π –ø–∞—Å–ø–æ—Ä—Ç" –±—É–¥–∏–Ω–∫—É (—ñ–Ω–µ—Ä—Ü—ñ—è —Ç–∞ –Ω–∞–≥—Ä—ñ–≤)
# [EN] Global variables - House "Technical Passport" (inertia and heating rates)
globals:
  # [UA] –î–∂–µ—Ä–µ–ª–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏: 1=Home Assistant, 2=–õ–æ–∫–∞–ª—å–Ω–∏–π BME280
  # [EN] Temperature source: 1=Home Assistant, 2=Local BME280
  - id: temp_source
    type: int
    restore_value: true
    initial_value: '0'   # 0=NONE, 1=HA, 2=BME

  # [UA] –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∞–ª—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤—ñ–¥ Home Assistant –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ –∑–≤'—è–∑–∫—É
  # [EN] Timestamp of the last valid data received from Home Assistant to verify connection stability
  - id: ha_stable_since
    type: uint32_t
    restore_value: false
    initial_value: '0'

  # [UA] –®–≤–∏–¥–∫—ñ—Å—Ç—å –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –±—É–¥–∏–Ω–∫—É (¬∞C/–≥–æ–¥). –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º measure_cooling
  # [EN] House cooling rate (¬∞C/h). Automatically updated by the measure_cooling script
  - id: cooling_rate_measured
    type: float
    restore_value: true
    initial_value: '0.0' # Cooling rate (¬∞C/h)

  # [UA] –®–≤–∏–¥–∫—ñ—Å—Ç—å –Ω–∞–≥—Ä—ñ–≤—É –±—É–¥–∏–Ω–∫—É (¬∞C/–≥–æ–¥). –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º measure_heating
  # [EN] House heating rate (¬∞C/h). Automatically updated by the measure_heating script
  - id: heating_rate_measured
    type: float
    restore_value: true
    initial_value: '0.0' # Heating rate (¬∞C/h)

  # [UA] –ü–æ—Ç–æ—á–Ω–µ –µ–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è –¥–ª—è PID-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞, —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–µ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ–Ω–µ—Ä—Ü—ñ—ó –±—É–¥—ñ–≤–ª—ñ
  # [EN] Current adaptive eco-offset for the PID controller, calculated based on house inertia
  - id: eco_offset
    type: float
    restore_value: false
    initial_value: '0.0'

  # [UA] –¢–∏–º—á–∞—Å–æ–≤—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è —Ñ—ñ–∫—Å–∞—Ü—ñ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Ç–∞ —á–∞—Å—É –Ω–∞ –ø–æ—á–∞—Ç–∫—É –≤–∏–º—ñ—Ä—é–≤–∞–ª—å–Ω–∏—Ö —Ü–∏–∫–ª—ñ–≤
  # [EN] Temporary variables to store temperature and time at the beginning of measurement cycles
  - id: temp_sample_start
    type: float
    restore_value: false
  - id: sample_time_start
    type: uint32_t
    restore_value: false
 
  # [UA] –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è –µ–∫–æ-—Ä–µ–∂–∏–º—É (0.6 - 0.9). –ö–æ—Ä–∏–≥—É—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º eco_self_learning
  # [EN] Eco mode self-learning gain (0.6 - 0.9). Adjusted daily by the eco_self_learning script
  - id: eco_gain
    type: float
    restore_value: true
    initial_value: ${ECO_GAIN_INIT}
  
  # [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –Ω–æ—á—ñ –≤ –≥–æ–¥–∏–Ω–∞—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è —Ç–µ–ø–ª–æ–≤—Ç—Ä–∞—Ç
  # [EN] Calculated night duration in hours used for predicting heat loss
  - id: night_duration_hours
    type: float
    restore_value: false
    initial_value: '8.0'

  # [UA] –ö—ñ–º–Ω–∞—Ç–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω—ñ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –ø–æ—Ö–∏–±–∫–∏ –Ω–∞–≥—Ä—ñ–≤—É
  # [EN] Room temperature at the moment night mode ends, used for heating error analysis
  - id: morning_temp
    type: float
    restore_value: false

  # [UA] –ü—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ –∑–∞–ø–æ–±—ñ–≥–∞—î –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É —Ü–∏–∫–ª—É —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è –ø—Ä–æ—Ç—è–≥–æ–º –æ–¥–Ω—ñ—î—ó –¥–æ–±–∏
  # [EN] Safety flag to prevent multiple self-learning cycle executions within a single day
  - id: night_ended_today
    type: bool
    restore_value: false
    initial_value: 'false'

  # [UA] –ö–µ—à –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤—ñ–¥–æ–º–æ—ó –≤—É–ª–∏—á–Ω–æ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –ø–æ–≥–æ–¥–Ω–æ—ó –∫—Ä–∏–≤–æ—ó —É —Ä–∞–∑—ñ –∑–±–æ—é Wi-Fi
  # [EN] Cache of the last known outdoor temperature for weather curve logic during Wi-Fi outages
  - id: last_valid_outside_temp
    type: float
    restore_value: true
    initial_value: '0.0'

  # [UA] –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–µ—à—É –≤—É–ª–∏—á–Ω–æ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é –π–æ–≥–æ "—Å–≤—ñ–∂–æ—Å—Ç—ñ" (–ª—ñ–º—ñ—Ç 2 –≥–æ–¥)
  # [EN] Timestamp of the last outdoor temperature cache update to monitor its age (2h limit)
  - id: last_outside_update_ms
    type: uint32_t
    restore_value: false
    initial_value: '0'

  - id: has_cached_outdoor_temp
    type: bool
    restore_value: true
    initial_value: 'false'

  - id: learning_quality_ok
    type: bool
    restore_value: false
    initial_value: 'false'

  - id: boiler_was_active_at_night
    type: bool
    restore_value: false
    initial_value: 'false'

  - id: night_mode_active
    type: bool
    restore_value: false
    initial_value: 'false'

  # [UA] –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –Ω–∞–≥—Ä—ñ–≤—É –≤ –≥–æ–¥–∏–Ω–∞—Ö
  # [EN] Preheat duration in hours
  - id: preheat_hours
    type: float
    restore_value: true
    initial_value: '0.5'

time:
  - platform: sntp
    id: sntp_time
    timezone: "Europe/Kyiv" # Please specify your time zone

# [UA] –ë–ª–æ–∫ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ–≤ –¥–ª—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ —Ç–∞ –∑–∞–ø—É—Å–∫—É –∞–ª–≥–æ—Ä–∏—Ç–º—ñ–≤
# [EN] Interval block for periodic checks and algorithm execution
interval:
  - interval: 60s
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          
          // [UA] –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Å—É —É –¥–µ—Å—è—Ç–∫–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞–ø—Ä., 7:30 = 7.5)
          // [EN] Converting current time to decimal format (e.g., 7:30 = 7.5)
          float current = now.hour + now.minute / 60.0f;

          // [UA] –°–∫–∏–¥–∞–Ω–Ω—è –ø—Ä–∞–ø–æ—Ä—Ü—è –ø—ñ—Å–ª—è –æ–ø—ñ–≤–Ω–æ—á—ñ –¥–ª—è –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–æ –Ω–æ–≤–æ–≥–æ —Ä–∞–Ω–∫–æ–≤–æ–≥–æ —Ü–∏–∫–ª—É
          // [EN] Resetting the flag after midnight to prepare for a new morning cycle
          if (current < 0.1f) {
            id(night_ended_today) = false;
          }

# Dallas Sensor
#one_wire:
#  - platform: gpio
#    pin: D5

# [UA] –ë–ª–æ–∫ –ø–µ—Ä–µ–º–∏–∫–∞—á—ñ–≤ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–∞ –ª–æ–≥—ñ—á–Ω–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–æ—é
# [EN] Switch block for manual and logical system control
# https://esphome.io/components/opentherm.html#switch
switch:
  # [UA] –î–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–∞
  # [EN] Remote restart of the thermostat
  - platform: restart
    name: "Thermostat restart"
    #web_server:
        #sorting_group_id: group_status

  # [UA] –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ–º–∏–∫–∞—á –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –ø–æ–≥–æ–¥–Ω–æ—ó –∫—Ä–∏–≤–æ—ó (Equithermic Curve)
  # [UA] –ö–æ–ª–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ, PID –æ–±–º–µ–∂—É—î—Ç—å—Å—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ—é –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—É–ª–∏—á–Ω–æ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏
  # [EN] Virtual switch to activate the Equithermic Curve logic
  # [EN] When enabled, PID is capped by temperature based on outdoor conditions
  - platform: template
    name: "Use Heating Curve"
    id: use_curve_logic
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:weather-partly-cloudy"
    # Let's add logging of switching events:
    on_turn_on:
      - lambda: |-
          //ESP_LOGI("heating_curve", "ENABLED Heating Curve logic. Max water temp is now dynamic.");
    on_turn_off:
      - lambda: |-
          //ESP_LOGI("heating_curve", "DISABLED Heating Curve logic. System back to pure PID control.");

  # [UA] –ê–ø–∞—Ä–∞—Ç–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç—É—Ä–∞–º–∏ –æ–ø–∞–ª–µ–Ω–Ω—è —Ç–∞ –≥–∞—Ä—è—á–æ—ó –≤–æ–¥–∏ —á–µ—Ä–µ–∑ OpenTherm
  # [EN] Hardware control for heating and domestic hot water (DHW) via OpenTherm
  - platform: opentherm
    # [UA] –î–æ–∑–≤–æ–ª—è—î Home Assistant –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–º–∫–Ω—É—Ç–∏ –∑–∞–ø–∏—Ç –Ω–∞ –æ–ø–∞–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ç–ª–∞
    # [EN] Allows Home Assistant to completely disable the boiler's heating request
    ch_enable:
      id: ch_enable
      name: "Heating"
      icon: mdi:radiator
      restore_mode: RESTORE_DEFAULT_OFF
      internal: false
      #web_server:
        #sorting_group_id: group_heating
  
    # [UA] –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø—ñ–¥—ñ–≥—Ä—ñ–≤–æ–º –≥–∞—Ä—è—á–æ—ó –≤–æ–¥–∏ (–ì–í–°)
    # [EN] Control for Domestic Hot Water (DHW) heating
    dhw_enable:
      id: dhw_enable
      name: "Hot Water"
      icon: mdi:water-thermometer-outline
      restore_mode: RESTORE_DEFAULT_OFF
      #web_server:
        #sorting_group_id: group_dhw

    # Allows you to enable/disable weather-dependent mode
#    otc_active:
#      id: otc_active
#      name: "OTC Active"

# Use outputs to control numerical values like Central Heating setpoint using some automatic algorithms
# [UA] –ë–ª–æ–∫ –≤–∏–≤–æ–¥—É –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ü—ñ–ª—å–æ–≤–æ—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ—é —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è
# [EN] Output block for controlling the central heating water temperature setpoint
output:
  - platform: opentherm
    t_set:
      id: ch_setpoint
      # [UA] –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω Bosch Gaz 6000 W: 40¬∞C - 82¬∞C.
      # [EN] Technical range for Bosch Gaz 6000 W: 40¬∞C - 82¬∞C.
      # [UA] –ü—ñ–¥–Ω—ñ–º–∞—î–º–æ "–ø—ñ–¥–ª–æ–≥—É" –¥–ª—è PID, —â–æ–± –∑–±—ñ–≥–∞–ª–∞—Å—è –∑ –ª—ñ–º—ñ—Ç–∞–º–∏ Heating Curve
      # [EN] Raising the PID "floor" to match Heating Curve limits
      min_value: ${MIN_BOILER_TEMP}
      max_value: ${MAX_BOILER_TEMP}
      # [UA] zero_means_zero: true –≥–∞—Ä–∞–Ω—Ç—É—î –ø–æ–≤–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –ø–∞–ª—å–Ω–∏–∫–∞ –ø—Ä–∏ –Ω—É–ª—å–æ–≤–æ–º—É –∑–∞–ø–∏—Ç—ñ –≤—ñ–¥ PID
      # [EN] zero_means_zero: true ensures the burner shuts off completely when PID request is zero
      zero_means_zero: true

  - platform: template
    id: pid_correction_output
    type: float
    write_action:
      - lambda: |-
          const bool is_night = id(night_mode).state;
          float base_t;

          // --- –í–ò–ë–Ü–† –î–ñ–ï–†–ï–õ–ê –û–ë–ú–ï–ñ–ï–ù–ù–Ø ---
          if (id(use_curve_logic).state) {
            // Curve ON ‚Üí –æ–±–º–µ–∂—É—î–º–æ PID –µ–∫–≤—ñ—Ç–µ—Ä–º—ñ—î—é
            base_t = id(equitherm_t_set).state;
            if (std::isnan(base_t)) base_t = 50.0;
          } else {
            // Curve OFF ‚Üí –ø–æ–≤–Ω–∞ —Å–≤–æ–±–æ–¥–∞ PID
            base_t = ${MAX_BOILER_TEMP};
          }
          
          // --- NIGHT MODE ---
          if (is_night) {
            base_t -= ${NIGHT_WATER_REDUCTION};
          }

          // --- –§–Ü–ó–ò–ß–ù–Ü –õ–Ü–ú–Ü–¢–ò –ö–û–¢–õ–ê ---
          base_t = clamp(base_t, (float)${MIN_BOILER_TEMP}, 80.0f);

          // [UA] –ü—Ä–∏–º—É—Å–æ–≤–∏–π –Ω—É–ª—å –¥–ª—è zero_means_zero
          // [EN] Forced zero for zero_means_zero logic
          // --- PID OFF + NaN guard ---
          if (!isfinite(state) || state <= 0.01f) {
            id(ch_setpoint).set_level(0.0f);
            return;
          }

          float pid_power = state; // –ó–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥ 0.01 –¥–æ 1.0
          float pid_min = (float)${MIN_BOILER_TEMP};
          float pid_max = base_t;
          
          // [UA] –ú–∞—Å—à—Ç–∞–±—É—î–º–æ PID –Ω–∞ –¥—ñ–∞–ø–∞–∑–æ–Ω [42 ... –ö—Ä–∏–≤–∞]
          float final_t = pid_min + (pid_power * (pid_max - pid_min));
          
          // --- Safety check ---
          if (!isfinite(final_t)) {
            //ESP_LOGE("output", "final_t NaN, boiler OFF");
            id(ch_setpoint).set_level(0.0f);
            return;
          }

          // [UA] –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —É –≤—ñ–¥—Å–æ—Ç–æ–∫ –¥–ª—è —Ñ—ñ–∑–∏—á–Ω–æ–≥–æ –≤–∏—Ö–æ–¥—É ch_setpoint (42-80¬∞C)
          float ch_percent = (final_t - pid_min) / (80.0f - pid_min);

          ch_percent = clamp(ch_percent, 0.0f, 1.0f);

          id(ch_setpoint).set_level(ch_percent);
          
          //ESP_LOGI("output", "Limit: %.1f, PID: %.1f%%, Final: %.1f¬∞C", base_t, state*100.0, final_t);
          //ESP_LOGI("debug", "Internal PID state: %.3f", state);

# Use numbers to control numerical values like CH/DHW setpoint from HA interface
# https://esphome.io/components/opentherm.html#numerical-values 
# [UA] –ë–ª–æ–∫ —á–∏—Å–ª–æ–≤–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ì–í–ü —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∏—Ö –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ —ñ–Ω–µ—Ä—Ü—ñ—ó –±—É–¥–∏–Ω–∫—É
# [EN] Number block for DHW settings and house inertia calculation coefficients
number:
  - platform: opentherm
#    t_set:
#      id: ch_setpoint
#      name: "Heating Setpoint"
#      step: 1
#      min_value: 30
#      max_value: 80
#      restore_value: true
#      initial_value: 60

  # [UA] –¶—ñ–ª—å–æ–≤–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–∞—Ä—è—á–æ—ó –≤–æ–¥–∏ (–ì–í–ü)
  # [EN] Domestic Hot Water (DHW) target temperature
    t_dhw_set:
      id: dhw_setpoint
      name: "Hot Water Setpoint"
      icon: mdi:water-check-outline
      step: 1
      min_value: 40
      max_value: 65
      restore_value: true
      initial_value: 60
      #web_server:
        #sorting_group_id: group_dhw
#    max_t_set:
#      id: ch_max_temp_limit
#      name: "–ú–∞–∫—Å. –ª—ñ–º—ñ—Ç —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è"
#      step: 1
#      min_value: 40  # Technical minimum Bosch Gaz 6000 W
#      max_value: 82  # Technical maximum Bosch Gaz 6000 W
#      restore_value: true
#      initial_value: 60
  
  # [UA] –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –±—É–¥–∏–Ω–∫—É. –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–º measure_cooling
  # [EN] House cooling rate coefficient. Updated automatically by the measure_cooling script
  - platform: template
    name: "Cooling Rate"
    id: cooling_rate_ui
    min_value: 0.0
    max_value: 2.0
    step: 0.01
    unit_of_measurement: "¬∞C/h"
    icon: "mdi:snowflake-thermometer"
    restore_value: true # Stores the entered value in ESP memory
    optimistic: true
    #web_server:
        #sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(cooling_rate_measured) = x;' # Updates a global variable when manually entered
        - script.execute: calculate_eco

  # [UA] –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ –Ω–∞–≥—Ä—ñ–≤—É –±—É–¥–∏–Ω–∫—É. –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–º measure_heating
  # [EN] House heating rate coefficient. Updated automatically by the measure_heating script
  - platform: template
    name: "Heating Rate"
    id: heating_rate_ui
    min_value: 0.0
    max_value: 3.0
    step: 0.01
    unit_of_measurement: "¬∞C/h"
    icon: "mdi:sun-thermometer-outline"
    restore_value: true
    optimistic: true
    #web_server:
        #sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(heating_rate_measured) = x;' # Updates a global variable when manually entered
        - script.execute: calculate_preheat_duration

  # [UA] –ü–æ—Ç–æ—á–Ω–µ –µ–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è. –†–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–≤–∏–¥–∫–æ—Å—Ç—ñ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è —Ç–∞ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –Ω–æ—á—ñ
  # [EN] Current eco-offset. Calculated dynamically based on cooling rate and night duration
  - platform: template
    name: "Eco Offset"
    id: eco_offset_ui
    min_value: 0.0
    max_value: 1.5
    step: 0.1
    unit_of_measurement: "¬∞C"
    icon: "mdi:leaf"
    restore_value: true # Stores the entered value in ESP memory
    optimistic: true
    #web_server:
      #sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(eco_offset) = x;' # Updates a global variable when manually entered

  # [UA] –ì–æ–¥–∏–Ω–∞ –ø–æ—á–∞—Ç–∫—É –Ω—ñ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –Ω–æ—á—ñ)
  # [EN] Night mode start hour (used for night duration calculation)
  - platform: template
    id: night_start_hour
    name: "Night Mode Start Hour"
    icon: mdi:weather-sunset-down
    min_value: 0
    max_value: 23
    step: 0.5
    optimistic: true
    restore_value: true
    initial_value: 23
    unit_of_measurement: "h"
    on_value:
      then:
        - script.execute: calc_night_duration

  # [UA] –ì–æ–¥–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω—ñ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
  # [EN] Night mode end hour
  - platform: template
    id: night_end_hour
    name: "Night Mode End Hour"
    icon: mdi:weather-sunset-up
    min_value: 0
    max_value: 23
    step: 0.5
    optimistic: true
    restore_value: true
    initial_value: 7
    unit_of_measurement: "h"
    on_value:
      then:
        - script.execute: calc_night_duration

  - platform: template
    name: "Curve Shift"
    icon: mdi:vector-curve
    id: curve_shift_ui
    min_value: -0.3
    max_value: 0.3
    step: 0.1
    initial_value: 0
    restore_value: true
    optimistic: true
    #web_server:
      #sorting_group_id: group_calculation

# Use binary sensors (on/off) to monitor the states and conditions of different boiler entities.
# https://esphome.io/components/opentherm.html#binary-sensor
# [UA] –ë—ñ–Ω–∞—Ä–Ω—ñ —Å–µ–Ω—Å–æ—Ä–∏ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —Å—Ç–∞–Ω—ñ–≤ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ –ø–æ–º–∏–ª–æ–∫ –∫–æ—Ç–ª–∞
# [EN] Binary sensors for monitoring system states and boiler faults
binary_sensor:
  # [UA] –ù—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º (–∑–∞ —Ä–æ–∑–∫–ª–∞–¥–æ–º). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –ø–æ–≤–∑—É–Ω–∫—ñ–≤ UI
  # [UA] –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–æ–±–ª—è—î –ø–µ—Ä–µ—Ö—ñ–¥ —á–µ—Ä–µ–∑ –ø—ñ–≤–Ω—ñ—á —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ —ñ–Ω–µ—Ä—Ü—ñ—ó
  # [EN] Night Mode (Scheduled). Uses values from UI sliders
  # [EN] Automatically handles midnight transition and triggers inertia calculations
  - platform: template
    id: night_mode
    name: "Night Mode (Scheduled)"
    icon: mdi:weather-night
    lambda: |-
      auto time = id(sntp_time).now();
      if (!time.is_valid()) return false; 

      float now_f = time.hour + time.minute / 60.0f;
      float start = id(night_start_hour).state;
      float end = id(night_end_hour).state;

      // [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —á–∞—Å—É –≤–∏—Ö–æ–¥—É
      // [EN] Calculation of the dynamic exit time
      float adjusted_end = end - id(preheat_hours);
      if (adjusted_end < 0) adjusted_end += 24.0f;

      float start_with_tol = start - ${NIGHT_TIME_TOLERANCE};

      if (start > adjusted_end) {
        // A case where the night lasts beyond midnight (e.g. 10:00 PM - 6:00 AM)
        return (now_f >= start || now_f < adjusted_end);
      } else {
        // The case when the start and end are within the same day (for example, 12:00 AM - 08:00 AM)
        return (now_f >= start && now_f < adjusted_end);
      }
    # [UA] –¢—Ä–∏–≥–µ—Ä–∏ –¥–ª—è –∑–∞–ø—É—Å–∫—É —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –≤ –Ω—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º
    # [EN] Triggers to start calculations when entering night mode
    on_press:
      - lambda: |-
          // [UA] 1. –û–¥—Ä–∞–∑—É –¥–∞—î–º–æ –∑–º—ñ—â–µ–Ω–Ω—è, —â–æ–± PID –≤–∏–º–∫–Ω—É–≤ –ø–∞–ª—å–Ω–∏–∫
          id(eco_offset) = ${ECO_OFFSET_DEFAULT}; 
          id(eco_offset_ui).publish_state(0.5f);

          // [UA] 2. –°–∫–∏–¥–∞—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å —Ä–æ–±–æ—Ç–∏, –ê–õ–ï –Ω–µ –∞–∫—Ç–∏–≤—É—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —â–µ
          id(boiler_was_active_at_night) = false;
          //ESP_LOGI("eco", "Night sequence started. Waiting for burner to cool down...");

      - delay: 60s # [UA] –¢–ï–•–ù–Ü–ß–ù–ê –ü–ê–£–ó–ê: –¥–∞—î–º–æ –ø–∞–ª—å–Ω–∏–∫—É —á–∞—Å —Ñ—ñ–∑–∏—á–Ω–æ –∑–≥–∞—Å–Ω—É—Ç–∏

      - lambda: |-
          // [UA] 3. –¢—ñ–ª—å–∫–∏ —Ç–µ–ø–µ—Ä –∞–∫—Ç–∏–≤—É—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ "–Ω—ñ—á –ø–æ—á–∞–ª–∞—Å—è" –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –ø–∞–ª—å–Ω–∏–∫–∞
          id(night_mode_active) = true;
          //ESP_LOGI("eco", "Night monitor ACTIVE. Now tracking accidental boiler starts.");
      - script.execute: measure_cooling
    on_release: # [UA] –°–ø—Ä–∞—Ü—å–æ–≤—É—î —Ç–æ—á–Ω–æ –≤ –º–æ–º–µ–Ω—Ç –≤–∏—Ö–æ–¥—É –∑ –ï–∫–æ-—Ä–µ–∂–∏–º—É (Preheat Start)
      - lambda: |-
          // 1. –ü–ï–†–ï–í–Ü–†–ö–ê: —á–∏ –º–∏ –≤–∂–µ –≤—á–∏–ª–∏—Å—è —Å—å–æ–≥–æ–¥–Ω—ñ?
          if (id(night_ended_today)) {
            //ESP_LOGD("eco", "Learning already finished for today. Skipping.");
            return;
          }

          // [UA] –§—ñ–∫—Å—É—î–º–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –û–î–†–ê–ó–£. –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –ø–∞–ª—å–Ω–∏–∫ –≤–º–∏–∫–∞—î—Ç—å—Å—è, 
          // —ñ–Ω–µ—Ä—Ü—ñ—è –≤–æ–¥–∏ –≤ –∫–æ—Ç–ª—ñ –¥–∞—î –Ω–∞–º "—á–∏—Å—Ç–∏–π" –∑–∞–º—ñ—Ä –ø–æ–≤—ñ—Ç—Ä—è.
          // –ë–µ—Ä–µ–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ HA –∞–±–æ BME –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ, —ñ–≥–Ω–æ—Ä—É—é—á–∏ smart_room_temperature
          if (id(temp_source) == 1) { // HA
              id(morning_temp) = id(in_temp_from_ha).state;
          } else { // BME
              id(morning_temp) = id(internal_temp_local).state;
          }
          
          id(night_mode_active) = false;
          
          //ESP_LOGI("eco", "Night ended by Preheat schedule. Morning Real Temp: %.2f", id(morning_temp));
          
          // 3. –ó–ê–ü–£–°–ö–ê–Ñ–ú–û –°–ö–†–ò–ü–¢–ò –ü–û–°–õ–Ü–î–û–í–ù–û
          id(evaluate_night_quality).execute();

          // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞, —â–æ–± evaluate –≤—Å—Ç–∏–≥ –æ–Ω–æ–≤–∏—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
          id(sntp_time).now(); // –ü—Ä–æ—Å—Ç–∏–π —Å–ø–æ—Å—ñ–± –¥–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å–æ—Ä—É "–¥–∏—Ö–Ω—É—Ç–∏"

          id(eco_self_learning).execute();

# Gas counter
#  - platform: gpio
#    pin:
#      number: D3
#      mode: INPUT_PULLUP
#      inverted: True
#    name: gas_counter
#    filters:
#      - delayed_on: 10 ms
#      - delayed_off: 10 ms

  # [UA] –°—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–∞ –¥–æ Home Assistant
  # [EN] Thermostat connectivity status to Home Assistant
  - platform: status
    name: "Status"
    icon: mdi:home-automation
    id: thermostat_status
    #web_server:
        #sorting_group_id: group_status

  # [UA] –°—Ç–∞—Ç—É—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∫–æ—Ç–ª–∞, —â–æ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ OpenTherm
  # [EN] Boiler activity statuses transmitted via OpenTherm
  - platform: opentherm
    #  [UA] –ü—Ä–∞—Ü—é—î –∫–æ–Ω—Ç—É—Ä –æ–ø–∞–ª–µ–Ω–Ω—è. [EN] Central Heating is active
    ch_active:
      id: ch_active
      name: "Heating Active"
      #web_server:
        #sorting_group_id: group_heating
  
    # [UA] –ü—Ä–∞—Ü—é—î –∫–æ–Ω—Ç—É—Ä –≥–∞—Ä—è—á–æ—ó –≤–æ–¥–∏. [EN] Domestic Hot Water is active
    dhw_active:
      id: dhw_active
      name: "Hot Water Active"
      #web_server:
        #sorting_group_id: group_dhw

    # [UA] –°—Ç–∞–Ω –ø–∞–ª—å–Ω–∏–∫–∞. –û—Å–Ω–æ–≤–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –≥–∞–∑—É.
    # [EN] Flame status. The primary indicator of gas consumption.   
    flame_on:
      id: flame_on
      name: "Flame On"
      on_press:
        then:
          - lambda: |-
              if (id(night_mode_active)) {
                id(boiler_was_active_at_night) = true;
              }
      #web_server:
        #sorting_group_id: group_heating

    # [UA] –î–Ü–ê–ì–ù–û–°–¢–ò–ß–ù–Ü –°–ï–ù–°–û–†–ò (–°–µ—Ä–≤—ñ—Å–Ω–∞ –≥—Ä—É–ø–∞)
    # [EN] DIAGNOSTIC SENSORS (Service group)
    
    # [UA] –ó–∞–≥–∞–ª—å–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—ñ: –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –ø—Ä–∏ –±—É–¥—å-—è–∫—ñ–π –∫—Ä–∏—Ç–∏—á–Ω—ñ–π –ø–æ–º–∏–ª—Ü—ñ –∫–æ—Ç–ª–∞
    # [EN] General boiler fault
    fault_indication:
      id: fault_indication
      name: "Boiler Fault"
      icon: "mdi:alert-octagon"
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_boiler_faults

    # [UA] –î—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∞ –ø–æ–¥—ñ—è: —Å–∏–≥–Ω–∞–ª—ñ–∑—É—î –ø—Ä–æ —Å–µ—Ä–≤—ñ—Å–Ω—É –ø–æ–¥—ñ—é, —â–æ –ø–æ—Ç—Ä–µ–±—É—î –∞–Ω–∞–ª—ñ–∑—É. [EN] Service required
    diagnostic_indication:
      id: diagnostic_indication
      name: "Boiler Diagnostic"
      icon: "mdi:magnify-scan"
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_boiler_faults

    # [UA] –ó–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤—ñ—Å: –≤–∫–∞–∑—É—î –Ω–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –ø–ª–∞–Ω–æ–≤–æ–≥–æ –¢–û. [EN] Service required
    service_request:
      name: "Service Required"
      icon: "mdi:hammer-wrench"
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_boiler_faults

    # [UA] –°—Ç–∞–Ω –±–ª–æ–∫—É–≤–∞–Ω–Ω—è: –∫–æ—Ç–µ–ª –ø–æ—Ç—Ä–µ–±—É—î –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "Reset". [EN] Lockout (requires manual Reset)
    lockout_reset:
      name: "Lockout Reset"
      icon: "mdi:lock-reset"
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_boiler_faults

    # [UA] –ù–∏–∑—å–∫–∏–π —Ç–∏—Å–∫ –≤–æ–¥–∏ (–ü–æ–º–∏–ª–∫–∞ CE —É Bosch). [EN] Low water pressure (Error CE in Bosch)
    low_water_pressure:
      name: "Low Water Pressure Fault"
      icon: "mdi:gauge-low"
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_boiler_faults

    # [UA] –ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø–∞–ª—É (–ü–æ–º–∏–ª–∫–∞ EA –∞–±–æ FA). [EN] Flame fault (Error EA or FA)
    flame_fault:
      name: "Flame Fault"
      icon: "mdi:fire-off"
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_boiler_faults

    # [UA] –ü—Ä–æ–±–ª–µ–º–∞ –∑ –¥–∏–º–æ—Ö–æ–¥–æ–º/–≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º (–ü–æ–º–∏–ª–∫–∏ C1‚ÄìC7). [EN] Air pressure fault (Errors C1‚ÄìC7).
    air_pressure_fault:
      name: "Air Pressure Fault"
      icon: "mdi:fan-alert"
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_boiler_faults

    # [UA] –ü–µ—Ä–µ–≥—Ä—ñ–≤ —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è (–ü–æ–º–∏–ª–∫–∞ E9). [EN] Water overtemperature (Error E9)
    water_over_temp:
      name: "Water Overtemperature"
      icon: "mdi:thermometer-alert"
      entity_category: diagnostic 
      #web_server:
        #sorting_group_id: group_boiler_faults

# [UA] –ë–ª–æ–∫ —Å–µ–Ω—Å–æ—Ä—ñ–≤: –∑–±—ñ—Ä –¥–∞–Ω–∏—Ö –∑ –∫–æ—Ç–ª–∞ —Ç–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è "—Ä–æ–∑—É–º–Ω–æ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏"
# [EN] Sensor block: gathering data from the boiler and implementing "smart temperature"
sensor:
  - platform: wifi_signal
    id: wifi_signal_dbm
    name: "WiFi Signal dBm"
    icon: mdi:signal-distance-variant
    #web_server:
        #sorting_group_id: group_wifi
    update_interval: 60s

  - platform: template
    name: "WiFi Signal %"
    #web_server:
        #sorting_group_id: group_wifi
    unit_of_measurement: "%"
    icon: mdi:wifi-star
    lambda: |-
      if (id(wifi_signal_dbm).state <= -100) {
        return 0;
      } else if (id(wifi_signal_dbm).state >= -50) {
        return 100;
      } else {
        return 2 * (id(wifi_signal_dbm).state + 100);
      }
    update_interval: 60s

  # [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ –≤–∏—Ç—Ä–∞—Ç–∞ –≥–∞–∑—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ –º–æ–¥—É–ª—è—Ü—ñ—ó –ø–∞–ª—å–Ω–∏–∫–∞ (–¥–ª—è –º–æ–¥–µ–ª—ñ 18 –∫–í—Ç)
  # [EN] Estimated gas flow based on burner modulation level (for 18kW model)
  - platform: template
    name: "Estimated Gas Flow"
    id: gas_flow_rate
    icon: mdi:meter-gas-outline
    unit_of_measurement: "m¬≥/h"
    accuracy_decimals: 3
    lambda: |-
      if (id(flame_on).state) {
        float modulation = id(rel_mod_level).state / 100.0f;
        // [UA] 2.1 - –º–∞–∫—Å. –≤–∏—Ç—Ä–∞—Ç–∞, 0.624 - –º—ñ–Ω. —Å—Ç–∞–±—ñ–ª—å–Ω–∞ –≤–∏—Ç—Ä–∞—Ç–∞.
        // [EN] 2.1 - max flow, 0.624 - min stable flow.
        return 0.624f + (modulation * (2.1f - 0.624f));
      }
      return 0.0;
    update_interval: 5s
    #web_server:
        #sorting_group_id: group_calculation

  - platform: debug
    free:
      name: "Free RAM, bytes"
      id: free_ram
      icon: mdi:memory
      unit_of_measurement: "bytes"
      #web_server:
        #sorting_group_id: group_status
    
    loop_time:
      name: "Loop time, ms"
      id: loop_time
      unit_of_measurement: "ms"
      #web_server:
        #sorting_group_id: group_status

  - platform: template
    name: "Free RAM, %"
    unit_of_measurement: "%"
    icon: mdi:memory
    accuracy_decimals: 1
    lambda: |-
      // For ESP8266 with your load, 45000 bytes is a realistic maximum
      float percentage = (id(free_ram).state / 45000.0) * 100.0;
      if (percentage > 100.0) percentage = 100.0;
      return percentage;
    #web_server:
      #sorting_group_id: group_status

  - platform: homeassistant
    entity_id: sensor.in_temperature 
    name: "Indoor Temp (HA Source)"
    id: in_temp_from_ha
    icon: mdi:home-thermometer
    internal: true 
    unit_of_measurement: "¬∞C" 
    device_class: temperature
    filters:
      # Push room temperature every second to update PID parameters
      - heartbeat: 5s
    #web_server:
        #sorting_group_id: group_temperature

  - platform: template
    name: "Outdoor Temperature (In Use)"
    id: outdoor_temp_in_use
    unit_of_measurement: "¬∞C"
    icon: mdi:thermometer-check
    # [UA] –û–Ω–æ–≤–ª—é—î–º–æ —Ä–∞–∑ –Ω–∞ —Ö–≤–∏–ª–∏–Ω—É, —â–æ–± –Ω–µ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ ESP8266
    # [EN] Update once per minute to avoid overloading ESP8266
    update_interval: 60s
    lambda: |-
      // [UA] –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: –¥–∞–Ω—ñ HA -> –∫–µ—à (–¥–æ 2 –≥–æ–¥) -> NAN (–ø–æ–º–∏–ª–∫–∞)
      // [EN] Priority: live HA data -> cache (up to 2h) -> NAN (error)
      if (!std::isnan(id(t_outside_ha).state)) {
        return id(t_outside_ha).state;
      }
      // [UA] –Ø–∫—â–æ HA –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–∏–π –∫–µ—à
      if (id(has_cached_outdoor_temp)) {
        // [UA] –ü—Ä–æ—Ç—è–≥–æ–º –ø–µ—Ä—à–∏—Ö 5 —Ö–≤–∏–ª–∏–Ω –ø—ñ—Å–ª—è —Ä–µ–±—É—Ç—É –¥–æ–≤—ñ—Ä—è—î–º–æ –∫–µ—à—É –±–µ–∑–ø–µ—Ä–µ—á–Ω–æ
        if (millis() < 300000) return id(last_valid_outside_temp);
        
        // [UA] –î–∞–ª—ñ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ 2 –≥–æ–¥–∏–Ω–∏
        if (id(last_outside_update_ms) > 0 && (millis() - id(last_outside_update_ms) < 7200000)) {
           //ESP_LOGD("temp", "HA data missing, using cached outdoor temp.");
           return id(last_valid_outside_temp);
        }
      }
      return NAN;

  - platform: homeassistant
    entity_id: sensor.external_weather_temp_sensor
    id: t_outside_ha
    icon: mdi:home-thermometer-outline
    internal: true
    name: "Outdoor Temp (HA Source)"
    unit_of_measurement: "¬∞C"
    device_class: temperature
    filters:
      # Push room temperature every second to update PID parameters
      - heartbeat: 5s
    #web_server:
        #sorting_group_id: group_temperature
    # Fixing data in global variables only when it gets a numeric value (not unknown)
    on_value:
      then:
        - lambda: |-
            if (!std::isnan(x)) {
              id(last_valid_outside_temp) = x;
              id(last_outside_update_ms) = millis();
              id(has_cached_outdoor_temp) = true; // [UA] –ö–µ—à —Ç–µ–ø–µ—Ä –æ—Ñ—ñ—Ü—ñ–π–Ω–æ —ñ—Å–Ω—É—î
            }

  - platform: template
    name: "Self-Learning Gain"
    id: eco_gain_sensor
    icon: "mdi:school-outline"
    accuracy_decimals: 2
    # [UA] –ó—á–∏—Ç—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä—è–º–æ –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó eco_gain
    lambda: |-
      return id(eco_gain);
    update_interval: 60s
    #web_server:
      #sorting_group_id: group_calculation # [UA] –î–æ–¥–∞—î–º–æ –≤ –≥—Ä—É–ø—É —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤ –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É

  - platform: uptime
    name: "Uptime seconds"
    id: uptime_sec
    update_interval: 60s
    #web_server:
        #sorting_group_id: group_status

# OpenTherm sensors
# https://esphome.io/components/opentherm.html#sensor
  - platform: opentherm
    t_boiler:
      id: ch_temperature
      name: "Heating Temperature"
      icon: mdi:thermometer
      #web_server:
        #sorting_group_id: group_heating
    t_dhw:
      id: dhw_temperature
      name: "Hot Water Temperature"
      icon: mdi:water-thermometer-outline
      #web_server:
        #sorting_group_id: group_dhw
    rel_mod_level:
      id: rel_mod_level
      name: "Boiler Relative Modulation Level"
      #web_server:
        #sorting_group_id: group_heating
#    t_outside:
#      name: Outside Temperature
#    t_ret:
#      name: "Boiler Return water temperature"
#    burner_starts:
#      name: "Boiler Number of starts burner"
#      entity_category: diagnostic
#    max_t_set:
#      name: CH Setpoint Max    
#      #web_server:
#        #sorting_group_id: group_heating
#    max_t_set_ub:
#      name: CH Setpoint Upper Bound   
#    max_t_set_lb:  
#      name: CH Setpoint Lower Bound
#    t_exhaust:    
#      name: Boiler Exhaust Temperature
#      entity_category: diagnostic
    # –ö–æ–¥–∏ –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (—á–∏—Å–ª–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥ –≤–∏—Ä–æ–±–Ω–∏–∫–∞)
    oem_fault_code:
      name: "OEM Fault Code"
      icon: "mdi:tumble-dryer-alert" # –í–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ —Ü–µ —á–∏—Å–ª–æ–≤–∏–π –∫–æ–¥ –ø–æ–º–∏–ª–∫–∏
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_system_info

    oem_diagnostic_code:
      name: "OEM Diagnostic Code"
      icon: "mdi:water-boiler-alert" # –ß–∏—Å–ª–æ–≤–∏–π –∫–æ–¥ –¥–ª—è —Ç–µ—Ö–Ω—ñ—á–Ω–æ—ó –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      entity_category: diagnostic
      #web_server:
        #sorting_group_id: group_system_info

    # –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—é (–ø–∞—Å–ø–æ—Ä—Ç –ø—Ä–∏—Å—Ç—Ä–æ—é)
    #device_id:
    #  name: "Boiler Device ID"
    #  icon: "mdi:identifier" # –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø—Ä–∏—Å—Ç—Ä–æ—é
    #  entity_category: diagnostic
    #  #web_server:
    #    #sorting_group_id: group_system_info
      
    #device_type:
    #  name: "Boiler Device Type"
    #  icon: "mdi:format-list-bulleted-type" # –¢–∏–ø –∞–±–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è
    #  entity_category: diagnostic
    #  #web_server:
    #    #sorting_group_id: group_system_info

    #device_version:
    #  name: "Boiler Device Version"
    #  icon: "mdi:label-variant-outline" # –í–µ—Ä—Å—ñ—è ¬´–∑–∞–ª—ñ–∑–∞¬ª –∞–±–æ –ø—Ä–æ—à–∏–≤–∫–∏ –∫–æ—Ç–ª–∞
    #  entity_category: diagnostic
    #  #web_server:
    #    #sorting_group_id: group_system_info

    # –¢–µ—Ö–Ω—ñ—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—Ä–æ—Ç–æ–∫–æ–ª –∑–≤'—è–∑–∫—É
    #opentherm_version_device:
    #  name: "Boiler OpenTherm Version"
    #  icon: "mdi:network-outline" # –í–µ—Ä—Å—ñ—è –ø—Ä–æ—Ç–æ–∫–æ–ª—É OpenTherm, —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –≤ –∫–æ—Ç–ª—ñ
    #  entity_category: diagnostic
    #  #web_server:
    #    #sorting_group_id: group_system_info

    # 1.6d: –ü–æ—Ç–æ—á–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å –ø—Ä–æ—Ç–æ–∫—É –≤–æ–¥–∏ —á–µ—Ä–µ–∑ —Ç—É—Ä–±—ñ–Ω—É (–ª/—Ö–≤)
    # –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É OpenTherm ID 19
    dhw_flow_rate:
      name: "Water Flow Rate"
      id: boiler_flow_rate
      accuracy_decimals: 1
      icon: "mdi:water-pump"
      #web_server:
        #sorting_group_id: group_dhw

    # 2.9b: –ü–æ—Ç–æ—á–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞
    # –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É OpenTherm ID 121
    fan_speed:
      name: "Fan Speed"
      id: boiler_fan_speed
      accuracy_decimals: 0
      icon: "mdi:fan"
      #web_server:
        #sorting_group_id: group_heating

  # [UA] –õ–æ–≥—ñ–∫–∞ Smart Room Temperature: –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç Home Assistant –∑ fallback –Ω–∞ BME280
  # [EN] Smart Room Temperature logic: Home Assistant priority with fallback to BME280
  - platform: template
    id: smart_room_temperature
    name: "Smart Room Temperature"
    icon: mdi:thermometer-auto
    unit_of_measurement: "¬∞C"
    device_class: "temperature"
    state_class: "measurement"
    accuracy_decimals: 2
    update_interval: 5s
    #web_server:
        #sorting_group_id: group_heating
    lambda: |-
      int new_source = 0;
      // [UA] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ HA (–º—ñ–Ω—ñ–º—É–º 10 —Å–µ–∫ –∑–≤'—è–∑–∫—É)
      // [EN] Checking HA stability (minimum 10 sec connection)
      const uint32_t HA_STABLE_TIME = ${HA_STABLE_TIME_MS}; // 10 —Å–µ–∫—É–Ω–¥ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ

      // --- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ HA ---
      if (id(thermostat_status).state &&
          id(in_temp_from_ha).has_state() &&
          isfinite(id(in_temp_from_ha).state)) {
          
        if (id(ha_stable_since) == 0) {
          id(ha_stable_since) = millis();
        }

        if (millis() - id(ha_stable_since) >= HA_STABLE_TIME) {
          new_source = 1; // HA
        }

      } else {
        id(ha_stable_since) = 0;
      }

      // --- Fallback –Ω–∞ BME ---
      if (new_source == 0 &&
          id(internal_temp_local).has_state() &&
          isfinite(id(internal_temp_local).state)) {
        new_source = 2; // BME
      }

      // --- Logging of switching ---
      if (new_source != id(temp_source)) {
        if (new_source == 1) {
          //ESP_LOGI("temp", "Temperature source switched to HOME ASSISTANT");
        } else if (new_source == 2) {
          //ESP_LOGW("temp", "Temperature source switched to BME280");
        } else {
          //ESP_LOGE("temp", "No valid temperature source available");
        }
        id(temp_source) = new_source;
      }

      // --- –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω–Ω—è ---
      float result = NAN; // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–º—ñ–Ω–Ω—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
      if (new_source == 1) {
        result = id(in_temp_from_ha).state;
      } else if (new_source == 2) {
        result = id(internal_temp_local).state;
      }

      // [UA] –î–æ–¥–∞–≤–∞–Ω–Ω—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –∑–º—ñ—â–µ–Ω–Ω—è –≤ –Ω—ñ—á–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ
      // [EN] Adding adaptive offset in night mode
      if (id(night_mode).state && isfinite(result) && isfinite(id(eco_offset))) {
        result += id(eco_offset); // [UA] –î–æ–¥–∞—î–º–æ –∑–º—ñ—â–µ–Ω–Ω—è –ª–∏—à–µ —è–∫—â–æ –æ–±–∏–¥–≤–∞ –∑–Ω–∞—á–µ–Ω–Ω—è –≤–∞–ª—ñ–¥–Ω—ñ
      }

      return result;

  - platform: template
    name: "Equithermic Target Temperature"
    id: equitherm_t_set
    unit_of_measurement: "¬∞C"
    icon: "mdi:chart-bell-curve-cumulative"
    lambda: |-
      float to = id(outdoor_temp_in_use).state;

      if (std::isnan(to)) {
        if (id(use_curve_logic).state) {
          // [UA] –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–º–∏–∫–∞—î–º–æ —Ä–µ–∂–∏–º, —è–∫—â–æ –¥–∂–µ—Ä–µ–ª–æ –ø–æ–≤–µ—Ä–Ω—É–ª–æ NAN (–∫–µ—à –≤–∏—á–µ—Ä–ø–∞–Ω–æ)
          // [EN] Automatically disable the mode if the source returns NAN (cache expired)
          id(use_curve_logic).turn_off();
          //ESP_LOGE("equitherm", "–í—É–ª–∏—á–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–∫–µ—à –ø–æ—Ä–æ–∂–Ω—ñ–π)! –†–µ–∂–∏–º –∫—Ä–∏–≤–æ—ó –í–ò–ú–ö–ù–ï–ù–û.");
        }
        return 50.0f; // [UA] –ë–µ–∑–ø–µ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ [EN] Safe fallback value
      }

      float tr = id(ch_climate).target_temperature; // –±–µ—Ä–µ–º–æ –ø–æ—Ç–æ—á–Ω—É —Ü—ñ–ª—å –∑ –∫–ª—ñ–º–∞—Ç—É

      if (std::isnan(tr)) {
        if (id(use_curve_logic).state) {
          id(use_curve_logic).turn_off();
          //ESP_LOGE("equitherm", "–í—É–ª–∏—á–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞! –†–µ–∂–∏–º –∫—Ä–∏–≤–æ—ó –í–ò–ú–ö–ù–ï–ù–û.");
        }
        return 50.0f; // [UA] –ë–µ–∑–ø–µ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ [EN] Safe fallback value
      }
      
      // [UA] –ë–∞–∑–æ–≤–∏–π –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π k (–ø–ª–∞–≤–Ω–∞ –ª—ñ–Ω—ñ—è –≤—ñ–¥ 1.4 –ø—Ä–∏ -20¬∞C –¥–æ 0.8 –ø—Ä–∏ +15¬∞C)
      float k_base = 1.125f - (0.0175f * to);

      // 2. –ö–æ—Ä–µ–∫—Ü—ñ—è –∑–∞ —ñ–Ω–µ—Ä—Ü—ñ—î—é (Cool Rate)
      // –ü—Ä–∏–π–º–∞—î–º–æ 0.4¬∞C/–≥–æ–¥ —è–∫ "–µ—Ç–∞–ª–æ–Ω" –¥–ª—è –≤–∞—à–æ–≥–æ k. 
      // –Ø–∫—â–æ cool_rate = 0.69, –º–∏ –º–Ω–æ–∂–∏–º–æ k –Ω–∞ 1.7, —Ä–æ–±–ª—è—á–∏ –∫—Ä–∏–≤—É –∑–Ω–∞—á–Ω–æ –∫—Ä—É—Ç—ñ—à–æ—é.
      float cr = id(cooling_rate_measured);

      if (std::isnan(cr)) {
        if (id(use_curve_logic).state) {
          id(use_curve_logic).turn_off();
          //ESP_LOGE("equitherm", "–í—É–ª–∏—á–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–∫–µ—à –ø–æ—Ä–æ–∂–Ω—ñ–π)! –†–µ–∂–∏–º –∫—Ä–∏–≤–æ—ó –í–ò–ú–ö–ù–ï–ù–û.");
        }
        return 50.0f; // [UA] –ë–µ–∑–ø–µ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ [EN] Safe fallback value
      }

      if (std::isnan(cr) || cr < 0.05f) cr = 0.35f; // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏—Ö –∑–∞–º—ñ—Ä—ñ–≤

      float inertia_adjustment = cr / 0.4f; 
      float k_final = k_base * inertia_adjustment;

      // [UA] –î–æ–¥–∞—î–º–æ —Ä—É—á–Ω—É –∫–æ—Ä–µ–∫—Ü—ñ—é —á–µ—Ä–µ–∑ –ø–æ–≤–∑—É–Ω–æ–∫ (Shift), –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 0
      // [EN] Adding manual correction via slider (Shift), default 0
      // –î–æ–¥–∞—î–º–æ —Ä—É—á–Ω–∏–π Shift —Ç–∞ –æ–±–º–µ–∂—É—î–º–æ k [0.7 - 2.0]
      k_final = clamp(k_final + id(curve_shift_ui).state, 0.7f, 2.0f);

      // [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞ –∫–ª–∞—Å–∏—á–Ω–æ—é —Ñ–æ—Ä–º—É–ª–æ—é –æ–ø–∞–ª—é–≤–∞–ª—å–Ω–æ—ó –∫—Ä–∏–≤–æ—ó
      // [EN] Calculation using the classic heating curve formula
      float t_water = tr + k_final * (tr - to);

      // [UA] –ê–ø–∞—Ä–∞—Ç–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è Bosch Gaz 6000 W (–¥—ñ–∞–ø–∞–∑–æ–Ω 40-80¬∞C)
      // [EN] Hardware limits for Bosch Gaz 6000 W (range 40-80¬∞C)
      if (t_water > 80.0f) t_water = 80.0f;
      if (t_water < (float)${MIN_BOILER_TEMP}) t_water = (float)${MIN_BOILER_TEMP};

      //ESP_LOGI("equitherm", "CoolRate: %.2f, Adj_k: %.2f, Max_T: %.1f", cr, k_final, t_water);
      
      return t_water;
    update_interval: 60s

  # Adding local sensor
  - platform: bme280_i2c
    temperature:
      name: "Internal Temperature"
      id: internal_temp_local
      icon: mdi:thermometer
      #web_server:
        #sorting_group_id: group_temperature
    pressure:
      name: "Internal Humidity"
      id: internal_humidity_local
      icon: mdi:gauge
      #web_server:
        #sorting_group_id: group_temperature
    humidity:
      name: "Barometric Pressure"
      id: internal_pressure_local
      icon: mdi:water-percent
      #web_server:
        #sorting_group_id: group_temperature
    address: 0x76
    update_interval: 30s

  - platform: template
    name: "Target Water Temp (PID)"
    id: pid_calculated_target
    unit_of_measurement: "¬∞C"
    accuracy_decimals: 1
    #web_server:
        #sorting_group_id: group_heating
    icon: "mdi:thermometer-lines"
    lambda: |-
      // –û—Å–∫—ñ–ª—å–∫–∏ ch_setpoint —É–∂–µ –ø–æ–≤–µ—Ä—Ç–∞—î –≥—Ä–∞–¥—É—Å–∏, –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º–æ –π–æ–≥–æ —Å—Ç–∞–Ω
      float target = id(ch_setpoint).state;
      
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤–∏–º–∫–Ω–µ–Ω–∏–π —Å—Ç–∞–Ω (—è–∫—â–æ zero_means_zero: true)
      if (target <= 0.0) return 0.0;
      
      return target;
    update_interval: 10s

  - platform: template
    name: "Temperature Deviation"
    id: temp_deviation
    unit_of_measurement: "¬∞C"
    accuracy_decimals: 2
    #web_server:
        #sorting_group_id: group_heating
    icon: mdi:delta
    lambda: |-
      // –û—Ç—Ä–∏–º—É—î–º–æ —Ü—ñ–ª—å–æ–≤—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑ –∫–ª—ñ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞
      float target = id(ch_climate).target_temperature;
      
      // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑ –≤–∞—à–æ–≥–æ "—Ä–æ–∑—É–º–Ω–æ–≥–æ" —Å–µ–Ω—Å–æ—Ä–∞
      float current = id(smart_room_temperature).state;
      
      // –Ø–∫—â–æ –¥–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ NAN
      if (std::isnan(current) || std::isnan(target)) {
        return NAN;
      }
      
      // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —Ä—ñ–∑–Ω–∏—Ü—é
      return target - current;
    update_interval: 30s

  - platform: template
    # [UA] –°–µ–Ω—Å–æ—Ä –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ–≥–æ —á–∞—Å—É –≤–∏–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
    # [EN] Sensor for displaying the calculated preheat time
    name: "Preheat Duration"
    id: preheat_hours_sensor
    unit_of_measurement: "h"
    icon: "mdi:clock-fast"
    accuracy_decimals: 1
    # [UA] –ó—á–∏—Ç—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä—è–º–æ –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó
    # [EN] Reading the value directly from the global variable
    lambda: |-
      return id(preheat_hours);
    update_interval: 60s # [UA] –û–Ω–æ–≤–ª—é—î–º–æ —Ä–∞–∑ –Ω–∞ —Ö–≤–∏–ª–∏–Ω—É [EN] Update every minute
    #web_server:
      #sorting_group_id: group_calculation # [UA] –î–æ–¥–∞—î–º–æ –≤ –≥—Ä—É–ø—É —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤

  #- platform: pid
  #  type: HEAT
  #  name: "PID Heat Output"
  #- platform: pid
  #  type: KP
  #  name: "PID kp"
  #  disabled_by_default: false
  #- platform: pid
  #  type: KI
  #  name: "PID ki"
  #  disabled_by_default: false
  #- platform: pid
  #  type: INTEGRAL
  #  name: "PID Climate Integral"
  #  disabled_by_default: false
  #- platform: pid
  #  type: DERIVATIVE
  #  name: "PID kd"
  #  disabled_by_default: false
  - platform: pid
    type: RESULT
    name: "PID Climate Result"
    disabled_by_default: false
    id: pid_result

# [UA] –¢–µ–∫—Å—Ç–æ–≤—ñ —Å–µ–Ω—Å–æ—Ä–∏: –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞ —Å–∏—Å—Ç–µ–º–Ω—ñ —Å—Ç–∞—Ç—É—Å–∏
# [EN] Text sensors: diagnostics and system statuses
text_sensor:
  - platform: debug
    reset_reason:
      name: "Reset Reason"
      id: reset_reason
      icon: mdi:math-log
      #web_server:
        #sorting_group_id: group_status

  - platform: template
    name: "Loop time state"
    icon: mdi:speedometer
    lambda: |-
      float val = id(loop_time).state;
      if (val < 10.0) return {"Fast"};
      if (val < 50.0) return {"Normal"};
      if (val < 100.0) return {"Long"};
      if (val < 200.0) return {"Too Long"};
      return {"Critical"};
    update_interval: 5s
    #web_server:
      #sorting_group_id: group_status

  # Thermostat operating time since last reset
  - platform: template
    name: "Uptime"
    icon: mdi:clock-outline
    entity_category: diagnostic
    update_interval: 60s
    #web_server:
      #sorting_group_id: group_status
    lambda: |-
      uint32_t s = (uint32_t) id(uptime_sec).state;

      uint32_t days = s / 86400;
      uint32_t hours = (s % 86400) / 3600;
      uint32_t minutes = (s % 3600) / 60;
      uint32_t seconds = s % 60;

      char buffer[32];
      snprintf(buffer, sizeof(buffer),
               "%u –¥–Ω. %02u:%02u:%02u",
               days, hours, minutes, seconds);
      return std::string{buffer};

  - platform: wifi_info
    ssid:
      name: "WiFi SSID"
      icon: mdi:wifi-check
      #web_server:
        #sorting_group_id: group_wifi
    ip_address:
      name: "WiFi IP Address"
      icon: mdi:wifi-settings
      #web_server:
        #sorting_group_id: group_wifi
    bssid:
      name: "WiFi BSSID"
      icon: mdi:wifi-cog
      #web_server:
        #sorting_group_id: group_wifi

  - platform: template
    name: "Analysis: Cooling"
    id: cooling_status
    icon: mdi:head-snowflake
    #web_server:
      #sorting_group_id: group_calculation

  - platform: template
    name: "Analysis: Heating"
    id: heating_status
    icon: mdi:fire-station
    #web_server:
      #sorting_group_id: group_calculation

  - platform: template
    name: "Analysis: Preheat"
    id: preheat_status
    icon: mdi:clock-check
    #web_server:
      #sorting_group_id: group_calculation

  - platform: template
    name: "Analysis: Eco Offset"
    id: eco_status
    icon: mdi:leaf-circle-outline
    #web_server:
      #sorting_group_id: group_calculation

  - platform: template
    name: "System: Learning"
    id: learning_status
    icon: mdi:brain
    #web_server:
      #sorting_group_id: group_calculation

# Use PID Climate component for automatic boiler setpoint calculation
# https://esphome.io/components/climate/pid
# [UA] –ë–ª–æ–∫ Climate: —Å–µ—Ä—Ü–µ —Å–∏—Å—Ç–µ–º–∏. –ö–µ—Ä—É—î PID-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–º –ª–æ–∫–∞–ª—å–Ω–æ
# [EN] Climate block: the heart of the system. Manages the PID controller locally
climate:
  - platform: pid
    id: ch_climate
    name: "Heating Climate"
    icon: mdi:thermostat-auto
    #web_server:
      #sorting_group_id: group_heating
    heat_output: pid_correction_output
    default_target_temperature: 21
    sensor: smart_room_temperature
    visual:
      min_temperature: 19
      max_temperature: 24
      temperature_step:
        target_temperature: 0.1
        current_temperature: 0.1
    control_parameters: 
      # [UA] kp: 0.4 - –º'—è–∫–∞ —Ä–µ–∞–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è —Ç–∞–∫—Ç—É–≤–∞–Ω–Ω—é
      # [EN] kp: 0.4 - soft reaction to prevent short cycling
      kp: 0.4
      ki: 0.002
      kd: 0
      # [UA] –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –ø—ñ–¥—ñ–≥—Ä—ñ–≤, —â–æ–± –∫–æ—Ç–µ–ª –Ω–µ —Å—Ç–æ—è–≤ —Ö–æ–ª–æ–¥–Ω–∏–º –ø—ñ—Å–ª—è —Ä–µ–±—É—Ç—É
      starting_integral_term: 0.15
      output_averaging_samples: 30
    deadband_parameters:
      threshold_high: 0.5
      threshold_low: -0.1
      kp_multiplier: 0.4
      ki_multiplier: 0.15
      kd_multiplier: 0.0
      deadband_output_averaging_samples: 40
    on_state:
      - lambda: |-
          // --- –°–ï–ö–¶–Ü–Ø 1: –ö–ï–†–£–í–ê–ù–ù–Ø –ñ–ò–í–õ–ï–ù–ù–Ø–ú –¢–ê –¶–ò–ö–õ–ê–ú–ò ---
          if (x.mode == CLIMATE_MODE_OFF) {
            id(ch_enable).turn_off();
          } else {
            // [UA] –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å PID (0.0...1.0)
            // [EN] Get current PID output power (0.0...1.0)
            float current_power = id(ch_climate).get_output_value();

            // [UA] –ó–∞–º—ñ—Å—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≥—Ä–∞–¥—É—Å—ñ–≤, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–∞–∂–∞–Ω–Ω—è PID –≥—Ä—ñ—Ç–∏ (–º–µ–Ω—à–µ 5%)
            // [EN] Instead of checking degrees, check PID's request for heat (less than 5%)
            if (current_power <= 0.05f) {
              bool cycle_on = (id(sntp_time).now().minute % 30) < 10;
              if (cycle_on) id(ch_enable).turn_on();
              else id(ch_enable).turn_off();
            } else {
              id(ch_enable).turn_on();
            }
            
            // –ù–∞–≤—á–∞–Ω–Ω—è –Ω–∞–≥—Ä—ñ–≤—É
            if (id(flame_on).state && !id(measure_heating).is_running()) {
              id(measure_heating).execute();
            }
          }

          // [UA] 2. –í–ü–†–û–í–ê–î–ñ–ï–ù–ù–Ø AUTOMATIC GAINS
          const bool is_night = id(night_mode).state;
          float outdoor = id(outdoor_temp_in_use).state;
          float base_kp = is_night ? ${KP_NIGHT} : ${KP_DAY};
          float base_ki = is_night ? ${KI_NIGHT} : ${KI_DAY};

          // [UA] –Ø–∫—â–æ –Ω–∞ –≤—É–ª–∏—Ü—ñ –º–æ—Ä–æ–∑–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥–Ω—ñ–º–∞—î–º–æ –∞–≥—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å PID
          // [EN] If it's freezing outside, automatically increase PID aggressiveness
          if (!std::isnan(outdoor) && outdoor < 0.0f) {
            base_kp += 0.05f; // –î–æ–¥–∞—î–º–æ —à–≤–∏–¥–∫–æ—Å—Ç—ñ —Ä–µ–∞–∫—Ü—ñ—ó
            base_ki += 0.0005f; // –®–≤–∏–¥—à–µ –Ω–∞–∫–æ–ø–∏—á—É—î–º–æ —ñ–Ω—Ç–µ–≥—Ä–∞–ª
          }
          
          if (!std::isnan(outdoor) && outdoor < -10.0f) {
            base_kp += 0.05f; // –©–µ –∞–≥—Ä–µ—Å–∏–≤–Ω—ñ—à–µ –≤ —Å–∏–ª—å–Ω–∏–π –º–æ—Ä–æ–∑
          }

          id(ch_climate).set_kp(base_kp);
          id(ch_climate).set_ki(base_ki);
          
          // 4. –õ–æ–≥—É–≤–∞–Ω–Ω—è
          //ESP_LOGI("climate", "Target: %.1f, Water: %.1f %s", 
          //         x.target_temperature, id(ch_setpoint).state,
          //         id(night_mode).state ? "(NIGHT MODE)" : "");

# [UA] –ë–ª–æ–∫ —Å–∫—Ä–∏–ø—Ç—ñ–≤ –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∫–ª–∞–¥–Ω–æ—ó –ª–æ–≥—ñ–∫–∏ —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤
# [EN] Script block for implementing complex self-learning logic and calculations
script:
  # [UA] –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –±—É–¥–∏–Ω–∫—É (–ø–∞—Å–∏–≤–Ω–∞ —ñ–Ω–µ—Ä—Ü—ñ—è)
  # [UA] –ü—Ä–∞—Ü—é—î 45 —Ö–≤–∏–ª–∏–Ω –ø—Ä–∏ –≤–∏–º–∫–Ω–µ–Ω–æ–º—É –ø–∞–ª—å–Ω–∏–∫—É –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è "—á–∏—Å—Ç–æ–≥–æ" —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
  # [EN] Measuring house cooling rate (passive inertia)
  # [EN] Runs for 45 minutes with the burner off to get a "clean" result
  - id: measure_cooling
    mode: restart
    then:
      - lambda: |-
          //ESP_LOGI("measure_cooling", "–û—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è. –ü–æ—á–∞—Ç–æ–∫ –∑–∞–º—ñ—Ä—É —ñ–Ω–µ—Ä—Ü—ñ—ó (45 —Ö–≤)...");
          // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –û–î–†–ê–ó–£ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ:
          id(cooling_status).publish_state("Measuring...");
          id(temp_sample_start) = id(smart_room_temperature).state;
          id(sample_time_start) = millis();
      - delay: ${COOLING_MEASURE_MINUTES}min
      - lambda: |-
          // [UA] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —è–∫—â–æ –∑–∞ —Ü–µ–π —á–∞—Å –∫–æ—Ç–µ–ª –≤–º–∏–∫–∞–≤—Å—è, –∑–∞–º—ñ—Ä –≤–≤–∞–∂–∞—î—Ç—å—Å—è –Ω–µ—Ç–æ—á–Ω–∏–º
          // [EN] Check: if the boiler turned on during this time, the measurement is considered inaccurate
          if (id(flame_on).state) {
            id(cooling_status).publish_state("Failed (boiler active)");
            return;
          }

          if (id(sample_time_start) == 0) return; 
          float dt = (millis() - id(sample_time_start)) / 3600000.0f;
          if (dt < 0.2f) return;

          float rate = (id(temp_sample_start) - id(smart_room_temperature).state) / dt;

          // [UA] –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó –∑ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é (0.7/0.3)
          // [EN] Result validation and global variable update with filtering (0.7/0.3)
          if (rate > 0.0f && rate < 2.0f) {
            id(cooling_rate_measured) = id(cooling_rate_measured) * ${EMA_ALPHA} + rate * (1.0f - ${EMA_ALPHA});
            id(cooling_status).publish_state("Calculated");
            id(cooling_rate_ui).publish_state(id(cooling_rate_measured));
            //ESP_LOGI("measure_cooling", "New cooling rate: %.2f ¬∞C/h", id(cooling_rate_measured));
            id(calculate_eco).execute(); 
          } else {
            id(cooling_status).publish_state("Failed (stable temp)");
          }

  # [UA] –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –Ω–∞–≥—Ä—ñ–≤—É –±—É–¥–∏–Ω–∫—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ñ–π —Ä–æ–±–æ—Ç—ñ –ø–∞–ª—å–Ω–∏–∫–∞
  # [EN] Measuring house heating rate during active burner operation
  - id: measure_heating
    mode: restart
    then:
      - lambda: |-
          // Notification of the start of the heating rate measurement process (log and sensor)
          id(heating_status).publish_state("Measuring...");
          //ESP_LOGI("measure_heating", "Heating measurement");
          
          id(temp_sample_start) = id(smart_room_temperature).state;
          id(sample_time_start) = millis();
      - delay: ${HEATING_MEASURE_MINUTES}min
      - lambda: |-
          // [UA] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–¥—É–ª—è—Ü—ñ—ó: –Ω–∞–≥—Ä—ñ–≤ —Ä–∞—Ö—É—î—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ > 10%
          // [EN] Modulation check: heating is only calculated if power > 10%
          if (!id(flame_on).state || id(rel_mod_level).state < 10) {
            id(heating_status).publish_state("Heating failed (Low power)");
            //ESP_LOGI("measure_heating", "Failed (low power)");
            return;
          }

          float dt = (millis() - id(sample_time_start)) / 3600000.0f;
          if (dt < 0.2f) return;

          float rate = (id(smart_room_temperature).state - id(temp_sample_start)) / dt;

          if (rate > 0.0f && rate <= 3.0f) {
            id(heating_rate_measured) = id(heating_rate_measured) * ${EMA_ALPHA} + rate * 0.3f;
            id(heating_status).publish_state("Calculated");
            id(heating_rate_ui).publish_state(id(heating_rate_measured));
            
            //ESP_LOGI("measure_heating", "New heating rate calculated: %.2f ¬∞C/h", id(heating_rate_measured));
          } else {
            //ESP_LOGI("measure_heating", "The measurement is inaccurate (no T growth)");
            id(heating_status).publish_state("Failed (stable T)");
          }

  - id: calculate_preheat_duration
    mode: restart
    then:
      - lambda: |-
          // [UA] –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –¥—ñ–ª–µ–Ω–Ω—é –Ω–∞ –Ω—É–ª—å –∞–±–æ –∑–∞–Ω–∞–¥—Ç–æ –º–∞–ª–æ–º—É –∑–Ω–∞—á–µ–Ω–Ω—é.
          // [EN] Prevent division by zero or too small a value.
          if (isfinite(id(eco_offset)) && isfinite(id(heating_rate_measured)) && id(heating_rate_measured) > 0.05f) {
            float hours = id(eco_offset) / id(heating_rate_measured);
            
            // [UA] –û–±–º–µ–∂—É—î–º–æ Preheat –º–∞–∫—Å–∏–º—É–º 4 –≥–æ–¥–∏–Ω–∞–º–∏ –¥–ª—è –±–µ–∑–ø–µ–∫–∏.
            // [EN] Limit Preheat to a maximum of 4 hours for safety.
            id(preheat_hours) = clamp(hours, 0.0f, ${MAX_PREHEAT_HOURS});
            
            //ESP_LOGI("preheat", "–†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ —á–∞—Å –≤–∏–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: %.1f –≥–æ–¥", id(preheat_hours));
            id(preheat_status).publish_state("Calculated");
          } else {
            id(preheat_hours) = 0.0f;
            id(preheat_status).publish_state("Pending (No data)");
          }

  # [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –µ–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è (offset) –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–æ—ó —ñ–Ω–µ—Ä—Ü—ñ—ó
  # [EN] Calculation of adaptive eco-offset based on current inertia
  - id: calculate_eco
    mode: restart
    then:
      - lambda: |-
          // –Ø–∫—â–æ –Ω—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º –≤–∏–º–∫–Ω–µ–Ω–æ, —Å–∫–∏–¥–∞—î–º–æ –∑–º—ñ—â–µ–Ω–Ω—è
          if (!id(night_mode).state) { 
            id(eco_offset) = 0.0;
            id(eco_offset_ui).publish_state(0.0);
            id(eco_status).publish_state("Reset");
            return; 
          }

          if (!isfinite(id(cooling_rate_measured)) || 
            !isfinite(id(night_duration_hours)) || 
            !isfinite(id(eco_gain))) {
          id(eco_offset) = 0.0;
          id(eco_status).publish_state("Invalid data");
          return;
          }

          // [UA] –§–æ—Ä–º—É–ª–∞: —à–≤–∏–¥–∫—ñ—Å—Ç—å –æ—Å—Ç–∏–≥–∞–Ω–Ω—è * —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –Ω–æ—á—ñ * –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è
          // [EN] Formula: cooling rate * night duration * self-learning gain
          float offset =
            id(cooling_rate_measured) *
            id(night_duration_hours) *
            id(eco_gain);

          // –û–±–º–µ–∂–µ–Ω–Ω—è (clamp), —â–æ–± –±—É–¥–∏–Ω–æ–∫ –Ω–µ –≤–∏—Ö–æ–ª–æ–¥–∏–≤—Å—è –±—ñ–ª—å—à–µ –Ω—ñ–∂ –Ω–∞ 1.5¬∞C
          id(eco_offset) = clamp(offset, ${ECO_OFFSET_MIN}, ${ECO_OFFSET_MAX});
          
          // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Home Assistant
          id(eco_offset_ui).publish_state(id(eco_offset));
          id(eco_status).publish_state("Calculated");
          
          //ESP_LOGI("calculate_eco", "Calculated adaptive offset: %.2f ¬∞C", id(eco_offset));
          id(calculate_preheat_duration).execute(); 

  # [UA] –°–∫—Ä–∏–ø—Ç —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è: —â–æ—Ä–∞–Ω–∫—É –∫–æ—Ä–∏–≥—É—î eco_gain –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ö–∏–±–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏
  # [EN] Self-learning script: adjusts eco_gain every morning based on temperature error
  - id: eco_self_learning
    mode: restart
    then:
      - lambda: |-
          if (!id(learning_quality_ok)) {
            //ESP_LOGI("eco", "Learning skipped: night quality not OK");
            return;
          }

          float error = id(morning_temp) - id(ch_climate).target_temperature;

          // –•–æ–ª–æ–¥–Ω–æ ‚Üí eco –±—É–≤ –∑–∞–≤–µ–ª–∏–∫–∏–π
          if (error < -0.3f) {
            id(eco_gain) -= ${ECO_GAIN_STEP};
          }
          // –ó–∞–Ω–∞–¥—Ç–æ —Ç–µ–ø–ª–æ ‚Üí –º–æ–∂–Ω–∞ –µ–∫–æ–Ω–æ–º–∏—Ç–∏ –±—ñ–ª—å—à–µ
          else if (error > 0.3f) {
            id(eco_gain) += ${ECO_GAIN_STEP};
          }

          id(eco_gain) = clamp(id(eco_gain), ${ECO_GAIN_MIN}, ${ECO_GAIN_MAX});

          //ESP_LOGI("eco", "Learning applied, new eco_gain=%.2f", id(eco_gain));

  # [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –Ω–æ—á—ñ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è —Ç–µ–ø–ª–æ–≤—Ç—Ä–∞—Ç
  # [EN] Night duration calculation for predicting heat loss
  - id: calc_night_duration
    mode: restart
    then:
      - lambda: |-
          float start = id(night_start_hour).state;
          float end   = id(night_end_hour).state;

          float hours = (end >= start)
            ? (end - start)
            : (24.0f - start + end);

          id(night_duration_hours) = hours;
      - script.execute: calculate_eco

  - id: evaluate_night_quality
    mode: restart
    then:
      - lambda: |-
          std::string status_msg = "Quality OK";
          bool ok = true;

          // 1. –Ñ –≤–∞–ª—ñ–¥–Ω–µ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è
          if (id(cooling_rate_measured) < ${MIN_VALID_COOLING_RATE}) {
            ok = false;
            status_msg = "Low cooling rate";
          }

          // 2. –ù—ñ—á –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–æ–≤–≥–∞
          else if (id(night_duration_hours) < ${MIN_NIGHT_DURATION}) {
            ok = false;
            status_msg = "Night too short";
          }

          // 3. –ö–æ—Ç–µ–ª –≤–º–∏–∫–∞–≤—Å—è
          else if (id(boiler_was_active_at_night)) {
            ok = false;
            status_msg = "Boiler active";
          }

          id(learning_quality_ok) = ok;
          id(night_ended_today) = true; // [UA] –ü–†–ê–ü–û–†–ï–¶–¨: –û—Ü—ñ–Ω–∫—É –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
          id(learning_status).publish_state(status_msg.c_str());


          if (ok) {
            //ESP_LOGI("eco", "Night quality check passed!");
          } else {
            //ESP_LOGW("eco", "Night quality check failed: %s", status_msg.c_str());
          }