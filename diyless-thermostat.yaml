# [UA] –ü—Ä–æ—î–∫—Ç —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–∞ –Ω–∞ –±–∞–∑—ñ Wemos D1 mini (ESP8266)
# [UA] –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≥–∞–∑–æ–≤–∏–º –∫–æ—Ç–ª–æ–º Bosch Gaz 6000 W —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª OpenTherm
# [EN] Advanced thermostat project based on Wemos D1 mini (ESP8266)
# [EN] for controlling Bosch Gaz 6000 W gas boiler via OpenTherm protocol

esphome:
  name: diyless-thermostat
  friendly_name: DIYLESS Thermostat

esp8266:
  board: d1_mini

# [UA] –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Ç–∞–π–º–∞—É—Ç—ñ–≤ OpenTherm
# [EN] Logging settings and automatic OpenTherm timeout tracking
logger:
  level: INFO
  on_message:
      - level: WARN
        then:
          - if:
              condition:
                # [UA] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Å–ª–æ–≤–∞ "timeout" —É —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ
                # [EN] Checking for the word "timeout" in the system message
                lambda: 'return std::string(message).find("timeout") != std::string::npos;'
              then:
                # [UA] –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ–º–∏–ª–∫–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤–∏–π —Å–µ–Ω—Å–æ—Ä
                # [EN] Publishing the error to a text sensor
                - text_sensor.template.publish:
                    id: last_timeout_msg
                    state: !lambda 'return message;'

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key
    
# Enable Over-The-Air (OTA) platform to remotely install modified/updated firmware
ota:
  - platform: esphome

# Enable debug sensors
debug:

# [UA] –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Wi-Fi –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Ä–æ—É–º—ñ–Ω–≥—É —Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –º–µ—Ä–µ–∂—ñ
# [EN] Wi-Fi settings with roaming support and backup network connectivity
wifi:
  fast_connect: true
  power_save_mode: NONE # [UA] –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è OpenTherm! [EN] Critical for OpenTherm!
  reboot_timeout: 0s # [UA] –ó–∞–ø–æ–±—ñ–≥–∞—î —Ä–µ–±—É—Ç—É –ø—Ä–∏ –∑–Ω–∏–∫–Ω–µ–Ω–Ω—ñ –º–µ—Ä–µ–∂—ñ. [EN] Prevents reboot on Wi-Fi loss
  output_power: 8.5dB # Optimized for a distance of 1 meter from the router
  post_connect_roaming: true # Automatic switching to a stronger signal

  networks:
    - ssid: !secret iot_wifi_ssid
      password: ""
      priority: 10

    - ssid: !secret main_wifi_ssid
      password: !secret wifi_password
      priority: 1

  manual_ip:
    static_ip: 192.168.0.112
    gateway: 192.168.0.1
    subnet: 255.255.255.0
    dns1: 192.168.0.1
    dns2: 8.8.8.8 # Backup DNS for stable time (NTP)

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "DIYLESS Thermostat"
    password: ""

# Enable captive portal as fallback mechanism for when connecting to the configured WiFi fails.
captive_portal:

# Enable simple web server to remotelly control the device using web interface
web_server:  
  version: 3
  local: true
  include_internal: false
  sorting_groups:
    - id: group_status
      name: "üõ∞Ô∏è Main status"
      sorting_weight: 1
    - id: group_heating
      name: "üî• Heating"
      sorting_weight: 2
    - id: group_temperature
      name: "üå°Ô∏è Temperature sensors"
      sorting_weight: 3
    - id: group_calculation
      name: "üßÆ Calculations"
      sorting_weight: 4
    - id: group_dhw
      name: "üöø Hot water"
      sorting_weight: 20
    - id: group_wifi
      name: "üõú Wi-Fi"
      sorting_weight: 30
    - id: group_system_info
      name: "‚öôÔ∏è System info"
      sorting_weight: 40
    - id: group_system_fault
      name: "‚ùå Errors"
      sorting_weight: 50  

# Enable OpenTherm communication
# https://esphome.io/components/opentherm.html
# [UA] –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∏–Ω–∏ OpenTherm. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ø—ñ–Ω–∏ D1 —Ç–∞ D2
# [EN] OpenTherm hub setup. Pins D1 and D2 are used
opentherm:
  in_pin: 4 # WeMos D1 Mini ESP32 input pin for stacking with Master OpenTherm Shield
  out_pin: 5 # WeMos D1 Mini ESP32 output pin for stacking with Master OpenTherm Shield
  # [UA] sync_mode: true —É—Å—É–≤–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω—å –ø—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ —ñ–Ω—à–∏—Ö –¥–∞—Ç—á–∏–∫—ñ–≤
  # [EN] sync_mode: true eliminates interrupt conflicts when using other sensors
  sync_mode: true
          
# Enable BME280 connection
# [UA] –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è I2C —à–∏–Ω–∏, –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ D6/D7 –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
# [EN] I2C bus configuration, moved to D6/D7 for hardware stability
i2c:
  sda: D6
  scl: D7
  scan: true

# [UA] –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ - "–¢–µ—Ö–Ω—ñ—á–Ω–∏–π –ø–∞—Å–ø–æ—Ä—Ç" –±—É–¥–∏–Ω–∫—É (—ñ–Ω–µ—Ä—Ü—ñ—è —Ç–∞ –Ω–∞–≥—Ä—ñ–≤)
# [EN] Global variables - House "Technical Passport" (inertia and heating rates)
globals:
  # [UA] –î–∂–µ—Ä–µ–ª–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏: 1=Home Assistant, 2=–õ–æ–∫–∞–ª—å–Ω–∏–π BME280
  # [EN] Temperature source: 1=Home Assistant, 2=Local BME280
  - id: temp_source
    type: int
    restore_value: true
    initial_value: '0'   # 0=NONE, 1=HA, 2=BME

  # [UA] –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∞–ª—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö –≤—ñ–¥ Home Assistant –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ –∑–≤'—è–∑–∫—É
  # [EN] Timestamp of the last valid data received from Home Assistant to verify connection stability
  - id: ha_stable_since
    type: uint32_t
    restore_value: false
    initial_value: '0'

  # [UA] –®–≤–∏–¥–∫—ñ—Å—Ç—å –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –±—É–¥–∏–Ω–∫—É (¬∞C/–≥–æ–¥). –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º measure_cooling
  # [EN] House cooling rate (¬∞C/h). Automatically updated by the measure_cooling script
  - id: cooling_rate
    type: float
    restore_value: true
    initial_value: '0.3' # Cooling rate (¬∞C/h)

  # [UA] –®–≤–∏–¥–∫—ñ—Å—Ç—å –Ω–∞–≥—Ä—ñ–≤—É –±—É–¥–∏–Ω–∫—É (¬∞C/–≥–æ–¥). –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º measure_heating
  # [EN] House heating rate (¬∞C/h). Automatically updated by the measure_heating script
  - id: heating_rate
    type: float
    restore_value: true
    initial_value: '0.5' # Heating rate (¬∞C/h)

  # [UA] –ü–æ—Ç–æ—á–Ω–µ –µ–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è –¥–ª—è PID-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞, —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–µ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ–Ω–µ—Ä—Ü—ñ—ó –±—É–¥—ñ–≤–ª—ñ
  # [EN] Current adaptive eco-offset for the PID controller, calculated based on house inertia
  - id: eco_offset
    type: float
    restore_value: false
    initial_value: '0.0'

  # [UA] –¢–∏–º—á–∞—Å–æ–≤—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è —Ñ—ñ–∫—Å–∞—Ü—ñ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Ç–∞ —á–∞—Å—É –Ω–∞ –ø–æ—á–∞—Ç–∫—É –≤–∏–º—ñ—Ä—é–≤–∞–ª—å–Ω–∏—Ö —Ü–∏–∫–ª—ñ–≤
  # [EN] Temporary variables to store temperature and time at the beginning of measurement cycles
  - id: temp_sample_start
    type: float
    restore_value: false
  - id: sample_time_start
    type: uint32_t
    restore_value: false
 
  # [UA] –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è –µ–∫–æ-—Ä–µ–∂–∏–º—É (0.6 - 0.9). –ö–æ—Ä–∏–≥—É—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º eco_self_learning
  # [EN] Eco mode self-learning gain (0.6 - 0.9). Adjusted daily by the eco_self_learning script
  - id: eco_gain
    type: float
    restore_value: true
    initial_value: '0.8'
  
  # [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –Ω–æ—á—ñ –≤ –≥–æ–¥–∏–Ω–∞—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è —Ç–µ–ø–ª–æ–≤—Ç—Ä–∞—Ç
  # [EN] Calculated night duration in hours used for predicting heat loss
  - id: night_duration_hours
    type: float
    restore_value: false
    initial_value: '8.0'

  # [UA] –ö—ñ–º–Ω–∞—Ç–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω—ñ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –ø–æ—Ö–∏–±–∫–∏ –Ω–∞–≥—Ä—ñ–≤—É
  # [EN] Room temperature at the moment night mode ends, used for heating error analysis
  - id: morning_temp
    type: float
    restore_value: false

  # [UA] –ü—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ –∑–∞–ø–æ–±—ñ–≥–∞—î –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É —Ü–∏–∫–ª—É —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è –ø—Ä–æ—Ç—è–≥–æ–º –æ–¥–Ω—ñ—î—ó –¥–æ–±–∏
  # [EN] Safety flag to prevent multiple self-learning cycle executions within a single day
  - id: night_ended_today
    type: bool
    restore_value: false
    initial_value: 'false'

  # [UA] –ö–µ—à –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤—ñ–¥–æ–º–æ—ó –≤—É–ª–∏—á–Ω–æ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –ø–æ–≥–æ–¥–Ω–æ—ó –∫—Ä–∏–≤–æ—ó —É —Ä–∞–∑—ñ –∑–±–æ—é Wi-Fi
  # [EN] Cache of the last known outdoor temperature for weather curve logic during Wi-Fi outages
  - id: last_valid_outside_temp
    type: float
    restore_value: true
    initial_value: '0.0'

  # [UA] –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–µ—à—É –≤—É–ª–∏—á–Ω–æ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é –π–æ–≥–æ "—Å–≤—ñ–∂–æ—Å—Ç—ñ" (–ª—ñ–º—ñ—Ç 2 –≥–æ–¥)
  # [EN] Timestamp of the last outdoor temperature cache update to monitor its age (2h limit)
  - id: last_outside_update_ms
    type: uint32_t
    restore_value: false
    initial_value: '0'

time:
  - platform: sntp
    id: sntp_time
    timezone: "Europe/Kyiv" # Please specify your time zone

# [UA] –ë–ª–æ–∫ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ–≤ –¥–ª—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ —Ç–∞ –∑–∞–ø—É—Å–∫—É –∞–ª–≥–æ—Ä–∏—Ç–º—ñ–≤
# [EN] Interval block for periodic checks and algorithm execution
interval:
  - interval: 60s
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;

          // [UA] –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Å—É —É –¥–µ—Å—è—Ç–∫–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞–ø—Ä., 7:30 = 7.5)
          // [EN] Converting current time to decimal format (e.g., 7:30 = 7.5)
          float current = now.hour + now.minute / 60.0;
          float end = id(night_end_hour).state;

          // [UA] –†–∞–Ω–∫–æ–≤–∏–π —Ç—Ä–∏–≥–µ—Ä: –∑–∞–ø—É—Å–∫–∞—î —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è —Ä—ñ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—ñ –∫—ñ–Ω—Ü—è –Ω–æ—á—ñ
          // [EN] Morning trigger: executes self-learning exactly once when night ends
          if (!id(night_ended_today) &&
              fabs(current - end) < 0.01) {

            id(night_ended_today) = true;
            id(eco_self_learning).execute();
          }

          // [UA] –°–∫–∏–¥–∞–Ω–Ω—è –ø—Ä–∞–ø–æ—Ä—Ü—è –ø—ñ—Å–ª—è –æ–ø—ñ–≤–Ω–æ—á—ñ –¥–ª—è –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–æ –Ω–æ–≤–æ–≥–æ —Ä–∞–Ω–∫–æ–≤–æ–≥–æ —Ü–∏–∫–ª—É
          // [EN] Resetting the flag after midnight to prepare for a new morning cycle
          if (current < 0.1) {
            id(night_ended_today) = false;
          }

# Dallas Sensor
#one_wire:
#  - platform: gpio
#    pin: D5

# [UA] –ë–ª–æ–∫ –ø–µ—Ä–µ–º–∏–∫–∞—á—ñ–≤ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–∞ –ª–æ–≥—ñ—á–Ω–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–æ—é
# [EN] Switch block for manual and logical system control
# https://esphome.io/components/opentherm.html#switch
switch:
  # [UA] –î–∏—Å—Ç–∞–Ω—Ü—ñ–π–Ω–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–∞
  # [EN] Remote restart of the thermostat
  - platform: restart
    name: "Thermostat restart"
    web_server:
        sorting_group_id: group_status

  # [UA] –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ–º–∏–∫–∞—á –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –ø–æ–≥–æ–¥–Ω–æ—ó –∫—Ä–∏–≤–æ—ó (Equithermic Curve)
  # [UA] –ö–æ–ª–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ, PID –æ–±–º–µ–∂—É—î—Ç—å—Å—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ—é –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—É–ª–∏—á–Ω–æ—ó —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏
  # [EN] Virtual switch to activate the Equithermic Curve logic
  # [EN] When enabled, PID is capped by temperature based on outdoor conditions
  - platform: template
    name: "Use Heating Curve"
    id: use_curve_logic
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    icon: "mdi:weather-partly-cloudy"
    # Let's add logging of switching events:
    on_turn_on:
      - lambda: |-
          ESP_LOGI("heating_curve", "ENABLED Heating Curve logic. Max water temp is now dynamic.");
    on_turn_off:
      - lambda: |-
          ESP_LOGI("heating_curve", "DISABLED Heating Curve logic. System back to pure PID control.");

  # [UA] –ê–ø–∞—Ä–∞—Ç–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç—É—Ä–∞–º–∏ –æ–ø–∞–ª–µ–Ω–Ω—è —Ç–∞ –≥–∞—Ä—è—á–æ—ó –≤–æ–¥–∏ —á–µ—Ä–µ–∑ OpenTherm
  # [EN] Hardware control for heating and domestic hot water (DHW) via OpenTherm
  - platform: opentherm
    # [UA] –î–æ–∑–≤–æ–ª—è—î Home Assistant –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–º–∫–Ω—É—Ç–∏ –∑–∞–ø–∏—Ç –Ω–∞ –æ–ø–∞–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ç–ª–∞
    # [EN] Allows Home Assistant to completely disable the boiler's heating request
    ch_enable:
      id: ch_enable
      name: "Heating"
      icon: mdi:radiator
      restore_mode: RESTORE_DEFAULT_OFF
      internal: false
      web_server:
        sorting_group_id: group_heating
  
    # [UA] –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø—ñ–¥—ñ–≥—Ä—ñ–≤–æ–º –≥–∞—Ä—è—á–æ—ó –≤–æ–¥–∏ (–ì–í–°)
    # [EN] Control for Domestic Hot Water (DHW) heating
    dhw_enable:
      id: dhw_enable
      name: "Hot Water"
      icon: mdi:water-thermometer-outline
      restore_mode: RESTORE_DEFAULT_OFF
      web_server:
        sorting_group_id: group_dhw

    # Allows you to enable/disable weather-dependent mode
#    otc_active:
#      id: otc_active
#      name: "OTC Active"

# Use outputs to control numerical values like Central Heating setpoint using some automatic algorithms
# [UA] –ë–ª–æ–∫ –≤–∏–≤–æ–¥—É –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ü—ñ–ª—å–æ–≤–æ—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ—é —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è
# [EN] Output block for controlling the central heating water temperature setpoint
output:
  - platform: opentherm
    t_set:
      id: ch_setpoint
      # [UA] –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω Bosch Gaz 6000 W: 40¬∞C - 82¬∞C.
      # [EN] Technical range for Bosch Gaz 6000 W: 40¬∞C - 82¬∞C.
      min_value: 40
      max_value: 80
      # [UA] zero_means_zero: true –≥–∞—Ä–∞–Ω—Ç—É—î –ø–æ–≤–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –ø–∞–ª—å–Ω–∏–∫–∞ –ø—Ä–∏ –Ω—É–ª—å–æ–≤–æ–º—É –∑–∞–ø–∏—Ç—ñ –≤—ñ–¥ PID
      # [EN] zero_means_zero: true ensures the burner shuts off completely when PID request is zero
      zero_means_zero: true

# Use numbers to control numerical values like CH/DHW setpoint from HA interface
# https://esphome.io/components/opentherm.html#numerical-values 
# [UA] –ë–ª–æ–∫ —á–∏—Å–ª–æ–≤–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ì–í–ü —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∏—Ö –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ —ñ–Ω–µ—Ä—Ü—ñ—ó –±—É–¥–∏–Ω–∫—É
# [EN] Number block for DHW settings and house inertia calculation coefficients
number:
  - platform: opentherm
#    t_set:
#      id: ch_setpoint
#      name: "Heating Setpoint"
#      step: 1
#      min_value: 30
#      max_value: 80
#      restore_value: true
#      initial_value: 60

  # [UA] –¶—ñ–ª—å–æ–≤–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–∞—Ä—è—á–æ—ó –≤–æ–¥–∏ (–ì–í–ü)
  # [EN] Domestic Hot Water (DHW) target temperature
    t_dhw_set:
      id: dhw_setpoint
      name: "How Water Setpoint"
      icon: mdi:water-check-outline
      step: 1
      min_value: 40
      max_value: 65
      restore_value: true
      initial_value: 60
      web_server:
        sorting_group_id: group_dhw
#    max_t_set:
#      id: ch_max_temp_limit
#      name: "–ú–∞–∫—Å. –ª—ñ–º—ñ—Ç —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è"
#      step: 1
#      min_value: 40  # Technical minimum Bosch Gaz 6000 W
#      max_value: 82  # Technical maximum Bosch Gaz 6000 W
#      restore_value: true
#      initial_value: 60
  
  # [UA] –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –±—É–¥–∏–Ω–∫—É. –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–º measure_cooling
  # [EN] House cooling rate coefficient. Updated automatically by the measure_cooling script
  - platform: template
    name: "–ë—É–¥–∏–Ω–æ–∫: –®–≤–∏–¥–∫—ñ—Å—Ç—å –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è"
    id: cooling_rate_ui
    min_value: 0.0
    max_value: 2.0
    step: 0.01
    unit_of_measurement: "¬∞C/h"
    icon: "mdi:snowflake-thermometer"
    restore_value: true # Stores the entered value in ESP memory
    optimistic: true
    web_server:
        sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(cooling_rate) = x;' # Updates a global variable when manually entered

  # [UA] –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ –Ω–∞–≥—Ä—ñ–≤—É –±—É–¥–∏–Ω–∫—É. –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–º measure_heating
  # [EN] House heating rate coefficient. Updated automatically by the measure_heating script
  - platform: template
    name: "–ë—É–¥–∏–Ω–æ–∫: –®–≤–∏–¥–∫—ñ—Å—Ç—å –Ω–∞–≥—Ä—ñ–≤—É"
    id: heating_rate_ui
    min_value: 0.0
    max_value: 3.0
    step: 0.01
    unit_of_measurement: "¬∞C/h"
    icon: "mdi:sun-thermometer-outline"
    restore_value: true
    optimistic: true
    web_server:
        sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(heating_rate) = x;' # Updates a global variable when manually entered

  # [UA] –ü–æ—Ç–æ—á–Ω–µ –µ–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è. –†–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–≤–∏–¥–∫–æ—Å—Ç—ñ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è —Ç–∞ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –Ω–æ—á—ñ
  # [EN] Current eco-offset. Calculated dynamically based on cooling rate and night duration
  - platform: template
    name: "–ë—É–¥–∏–Ω–æ–∫: –ï–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è"
    id: eco_offset_ui
    min_value: 0.0
    max_value: 1.5
    step: 0.1
    unit_of_measurement: "¬∞C"
    icon: "mdi:leaf"
    restore_value: true # Stores the entered value in ESP memory
    optimistic: true
    web_server:
      sorting_group_id: group_calculation
    on_value:
      then:
        - lambda: 'id(eco_offset) = x;' # Updates a global variable when manually entered

  # [UA] –ì–æ–¥–∏–Ω–∞ –ø–æ—á–∞—Ç–∫—É –Ω—ñ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –Ω–æ—á—ñ)
  # [EN] Night mode start hour (used for night duration calculation)
  - platform: template
    id: night_start_hour
    name: "Night Mode Start Hour"
    icon: mdi:weather-sunset-down
    min_value: 0
    max_value: 23
    step: 0.5
    optimistic: true
    restore_value: true
    initial_value: 23
    unit_of_measurement: "h"
    on_value:
      then:
        - script.execute: calc_night_duration

  # [UA] –ì–æ–¥–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω—ñ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
  # [EN] Night mode end hour
  - platform: template
    id: night_end_hour
    name: "Night Mode End Hour"
    icon: mdi:weather-sunset-up
    min_value: 0
    max_value: 23
    step: 0.5
    optimistic: true
    restore_value: true
    initial_value: 7
    unit_of_measurement: "h"
    on_value:
      then:
        - script.execute: calc_night_duration

# Use binary sensors (on/off) to monitor the states and conditions of different boiler entities.
# https://esphome.io/components/opentherm.html#binary-sensor
# [UA] –ë—ñ–Ω–∞—Ä–Ω—ñ —Å–µ–Ω—Å–æ—Ä–∏ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —Å—Ç–∞–Ω—ñ–≤ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ –ø–æ–º–∏–ª–æ–∫ –∫–æ—Ç–ª–∞
# [EN] Binary sensors for monitoring system states and boiler faults
binary_sensor:
  # [UA] –ù—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º (–∑–∞ —Ä–æ–∑–∫–ª–∞–¥–æ–º). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –ø–æ–≤–∑—É–Ω–∫—ñ–≤ UI
  # [UA] –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–æ–±–ª—è—î –ø–µ—Ä–µ—Ö—ñ–¥ —á–µ—Ä–µ–∑ –ø—ñ–≤–Ω—ñ—á —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ —ñ–Ω–µ—Ä—Ü—ñ—ó
  # [EN] Night Mode (Scheduled). Uses values from UI sliders
  # [EN] Automatically handles midnight transition and triggers inertia calculations
  - platform: template
    id: night_mode
    name: "Night Mode (Scheduled)"
    icon: mdi:weather-night
    lambda: |-
      auto time = id(sntp_time).now();
      if (!time.is_valid()) return false; 

      float now_f = time.hour + time.minute / 60.0f;
      float start = id(night_start_hour).state;
      float end = id(night_end_hour).state;

      if (start > end) {
        // A case where the night lasts beyond midnight (e.g. 10:00 PM - 6:00 AM)
        return (now_f >= start || now_f < end);
      } else {
        // The case when the start and end are within the same day (for example, 12:00 AM - 08:00 AM)
        return (now_f >= start && now_f < end);
      }
    # [UA] –¢—Ä–∏–≥–µ—Ä–∏ –¥–ª—è –∑–∞–ø—É—Å–∫—É —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –≤ –Ω—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º
    # [EN] Triggers to start calculations when entering night mode
    on_press:
      - script.execute: measure_cooling
      - script.execute: calculate_eco

# Gas counter
#  - platform: gpio
#    pin:
#      number: D3
#      mode: INPUT_PULLUP
#      inverted: True
#    name: gas_counter
#    filters:
#      - delayed_on: 10 ms
#      - delayed_off: 10 ms

  # [UA] –°—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç–∞ –¥–æ Home Assistant
  # [EN] Thermostat connectivity status to Home Assistant
  - platform: status
    name: "Status"
    icon: mdi:home-automation
    id: thermostat_status
    web_server:
        sorting_group_id: group_status

  # [UA] –°—Ç–∞—Ç—É—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∫–æ—Ç–ª–∞, —â–æ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ OpenTherm
  # [EN] Boiler activity statuses transmitted via OpenTherm
  - platform: opentherm
    #  [UA] –ü—Ä–∞—Ü—é—î –∫–æ–Ω—Ç—É—Ä –æ–ø–∞–ª–µ–Ω–Ω—è. [EN] Central Heating is active
    ch_active:
      id: ch_active
      name: "Heating Active"
      web_server:
        sorting_group_id: group_heating
  
    # [UA] –ü—Ä–∞—Ü—é—î –∫–æ–Ω—Ç—É—Ä –≥–∞—Ä—è—á–æ—ó –≤–æ–¥–∏. [EN] Domestic Hot Water is active
    dhw_active:
      id: dhw_active
      name: "Hot Water Active"
      web_server:
        sorting_group_id: group_dhw

    # [UA] –°—Ç–∞–Ω –ø–∞–ª—å–Ω–∏–∫–∞. –û—Å–Ω–æ–≤–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –≥–∞–∑—É.
    # [EN] Flame status. The primary indicator of gas consumption.   
    flame_on:
      id: flame_on
      name: "Flame On"
      web_server:
        sorting_group_id: group_heating

    # [UA] –î–Ü–ê–ì–ù–û–°–¢–ò–ß–ù–Ü –°–ï–ù–°–û–†–ò (–°–µ—Ä–≤—ñ—Å–Ω–∞ –≥—Ä—É–ø–∞)
    # [EN] DIAGNOSTIC SENSORS (Service group)
    
    # [UA] –ó–∞–≥–∞–ª—å–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—ñ: –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –ø—Ä–∏ –±—É–¥—å-—è–∫—ñ–π –∫—Ä–∏—Ç–∏—á–Ω—ñ–π –ø–æ–º–∏–ª—Ü—ñ –∫–æ—Ç–ª–∞
    # [EN] General boiler fault
    fault_indication:
      id: fault_indication
      name: "Boiler Fault"
      icon: "mdi:alert-octagon"
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # [UA] –î—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∞ –ø–æ–¥—ñ—è: —Å–∏–≥–Ω–∞–ª—ñ–∑—É—î –ø—Ä–æ —Å–µ—Ä–≤—ñ—Å–Ω—É –ø–æ–¥—ñ—é, —â–æ –ø–æ—Ç—Ä–µ–±—É—î –∞–Ω–∞–ª—ñ–∑—É. [EN] Service required
    diagnostic_indication:
      id: diagnostic_indication
      name: "Boiler Diagnostic"
      icon: "mdi:magnify-scan"
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # [UA] –ó–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤—ñ—Å: –≤–∫–∞–∑—É—î –Ω–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –ø–ª–∞–Ω–æ–≤–æ–≥–æ –¢–û. [EN] Service required
    service_request:
      name: "Service Required"
      icon: "mdi:hammer-wrench"
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # [UA] –°—Ç–∞–Ω –±–ª–æ–∫—É–≤–∞–Ω–Ω—è: –∫–æ—Ç–µ–ª –ø–æ—Ç—Ä–µ–±—É—î –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "Reset". [EN] Lockout (requires manual Reset)
    lockout_reset:
      name: "Lockout Reset"
      icon: "mdi:lock-reset"
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # [UA] –ù–∏–∑—å–∫–∏–π —Ç–∏—Å–∫ –≤–æ–¥–∏ (–ü–æ–º–∏–ª–∫–∞ CE —É Bosch). [EN] Low water pressure (Error CE in Bosch)
    low_water_pressure:
      name: "Low Water Pressure Fault"
      icon: "mdi:gauge-low"
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # [UA] –ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø–∞–ª—É (–ü–æ–º–∏–ª–∫–∞ EA –∞–±–æ FA). [EN] Flame fault (Error EA or FA)
    flame_fault:
      name: "Flame Fault"
      icon: "mdi:fire-off"
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # [UA] –ü—Ä–æ–±–ª–µ–º–∞ –∑ –¥–∏–º–æ—Ö–æ–¥–æ–º/–≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–æ–º (–ü–æ–º–∏–ª–∫–∏ C1‚ÄìC7). [EN] Air pressure fault (Errors C1‚ÄìC7).
    air_pressure_fault:
      name: "Air Pressure Fault"
      icon: "mdi:fan-alert"
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_fault

    # [UA] –ü–µ—Ä–µ–≥—Ä—ñ–≤ —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è (–ü–æ–º–∏–ª–∫–∞ E9). [EN] Water overtemperature (Error E9)
    water_over_temp:
      name: "Water Overtemperature"
      icon: "mdi:thermometer-alert"
      entity_category: diagnostic 
      web_server:
        sorting_group_id: group_system_fault

sensor:
  - platform: wifi_signal
    id: wifi_signal_dbm
    name: "WiFi Signal dBm"
    icon: mdi:signal-distance-variant
    web_server:
        sorting_group_id: group_wifi
    update_interval: 30s

  - platform: template
    name: "WiFi Signal %"
    web_server:
        sorting_group_id: group_wifi
    unit_of_measurement: "%"
    icon: mdi:wifi-star
    lambda: |-
      if (id(wifi_signal_dbm).state <= -100) {
        return 0;
      } else if (id(wifi_signal_dbm).state >= -50) {
        return 100;
      } else {
        return 2 * (id(wifi_signal_dbm).state + 100);
      }
    update_interval: 30s

# Approximate calculation of gas consumption based on modulation
  - platform: template
    name: "Estimated Gas Flow"
    id: gas_flow_rate
    icon: mdi:meter-gas-outline
    unit_of_measurement: "m¬≥/h"
    accuracy_decimals: 3
    lambda: |-
      if (id(flame_on).state) {
        float modulation = id(rel_mod_level).state / 100.0;
        // 2.1 - max. flow rate, 0.624 - min. flow rate at min. stable flame (18kW model)
        return 0.624 + (modulation * (2.1 - 0.624));
      }
      return 0.0;
    update_interval: 2s
    web_server:
        sorting_group_id: group_calculation

  - platform: debug
    free:
      name: "Free RAM, bytes"
      id: free_ram
      icon: mdi:memory
      unit_of_measurement: "bytes"
      web_server:
        sorting_group_id: group_status
    
    loop_time:
      name: "Loop time, ms"
      id: loop_time
      unit_of_measurement: "ms"
      web_server:
        sorting_group_id: group_status

  - platform: template
    name: "Free RAM, %"
    unit_of_measurement: "%"
    icon: mdi:memory
    accuracy_decimals: 1
    lambda: |-
      // For ESP8266 with your load, 45000 bytes is a realistic maximum
      float percentage = (id(free_ram).state / 45000.0) * 100.0;
      if (percentage > 100.0) percentage = 100.0;
      return percentage;
    web_server:
      sorting_group_id: group_status

  - platform: homeassistant
    entity_id: sensor.in_temperature 
    name: "–í–Ω—É—Ç—Ä—ñ—à–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (HA)"
    id: in_temp_from_ha
    icon: mdi:home-thermometer
    internal: true 
    unit_of_measurement: "¬∞C" 
    device_class: temperature
    filters:
      # Push room temperature every second to update PID parameters
      - heartbeat: 5s
    web_server:
        sorting_group_id: group_temperature

  - platform: homeassistant
    entity_id: sensor.external_weather_temp_sensor
    id: t_outside_ha
    icon: mdi:home-thermometer-outline
    internal: true
    name: "–í—É–ª–∏—á–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (HA)"
    unit_of_measurement: "¬∞C"
    device_class: temperature
    web_server:
        sorting_group_id: group_temperature
    # Fixing data in global variables only when it gets a numeric value (not unknown)
    on_value:
      then:
        - lambda: |-
            if (!std::isnan(x)) {
              id(last_valid_outside_temp) = x;
              id(last_outside_update_ms) = millis();
            }

  - platform: uptime
    name: "Uptime seconds"
    id: uptime_sec
    web_server:
        sorting_group_id: group_status

# OpenTherm sensors
# https://esphome.io/components/opentherm.html#sensor
  - platform: opentherm
    t_boiler:
      id: ch_temperature
      name: "Heating Temperature"
      icon: mdi:thermometer
      web_server:
        sorting_group_id: group_heating
    t_dhw:
      id: dhw_temperature
      name: "Hot Water Temperature"
      icon: mdi:water-thermometer-outline
      web_server:
        sorting_group_id: group_dhw
    rel_mod_level:
      id: rel_mod_level
      name: "Boiler Relative Modulation Level"
      web_server:
        sorting_group_id: group_heating
#    t_outside:
#      name: Outside Temperature
#    t_ret:
#      name: Return Water Temperature
#    max_t_set:
#      name: CH Setpoint Max    
#      web_server:
#        sorting_group_id: group_heating
#    max_t_set_ub:
#      name: CH Setpoint Upper Bound   
#    max_t_set_lb:  
#      name: CH Setpoint Lower Bound
#    t_exhaust:    
#      name: Boiler Exhaust Temperature
#      entity_category: diagnostic
    # –ö–æ–¥–∏ –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (—á–∏—Å–ª–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥ –≤–∏—Ä–æ–±–Ω–∏–∫–∞)
    oem_fault_code:
      name: "OEM Fault Code"
      icon: "mdi:tumble-dryer-alert" # –í–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ —Ü–µ —á–∏—Å–ª–æ–≤–∏–π –∫–æ–¥ –ø–æ–º–∏–ª–∫–∏
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    oem_diagnostic_code:
      name: "OEM Diagnostic Code"
      icon: "mdi:water-boiler-alert" # –ß–∏—Å–ª–æ–≤–∏–π –∫–æ–¥ –¥–ª—è —Ç–µ—Ö–Ω—ñ—á–Ω–æ—ó –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    # –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—é (–ø–∞—Å–ø–æ—Ä—Ç –ø—Ä–∏—Å—Ç—Ä–æ—é)
    device_id:
      name: "Boiler Device ID"
      icon: "mdi:identifier" # –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø—Ä–∏—Å—Ç—Ä–æ—é
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info
      
    device_type:
      name: "Boiler Device Type"
      icon: "mdi:format-list-bulleted-type" # –¢–∏–ø –∞–±–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    device_version:
      name: "Boiler Device Version"
      icon: "mdi:label-variant-outline" # –í–µ—Ä—Å—ñ—è ¬´–∑–∞–ª—ñ–∑–∞¬ª –∞–±–æ –ø—Ä–æ—à–∏–≤–∫–∏ –∫–æ—Ç–ª–∞
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    # –¢–µ—Ö–Ω—ñ—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—Ä–æ—Ç–æ–∫–æ–ª –∑–≤'—è–∑–∫—É
    opentherm_version_device:
      name: "Boiler OpenTherm Version"
      icon: "mdi:network-outline" # –í–µ—Ä—Å—ñ—è –ø—Ä–æ—Ç–æ–∫–æ–ª—É OpenTherm, —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –≤ –∫–æ—Ç–ª—ñ
      entity_category: diagnostic
      web_server:
        sorting_group_id: group_system_info

    # 1.6d: –ü–æ—Ç–æ—á–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å –ø—Ä–æ—Ç–æ–∫—É –≤–æ–¥–∏ —á–µ—Ä–µ–∑ —Ç—É—Ä–±—ñ–Ω—É (–ª/—Ö–≤)
    # –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É OpenTherm ID 19
    dhw_flow_rate:
      name: "Water Flow Rate"
      id: boiler_flow_rate
      accuracy_decimals: 1
      icon: "mdi:water-pump"
      web_server:
        sorting_group_id: group_dhw

    # 2.9b: –ü–æ—Ç–æ—á–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞
    # –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É OpenTherm ID 121
    fan_speed:
      name: "Fan Speed"
      id: boiler_fan_speed
      accuracy_decimals: 0
      icon: "mdi:fan"
      web_server:
        sorting_group_id: group_heating

# Checking data availability from HA and, if not, switching to the internal sensor
  - platform: template
    id: smart_room_temperature
    name: "Smart Room Temperature"
    icon: mdi:thermometer-auto
    unit_of_measurement: "¬∞C"
    device_class: "temperature"
    state_class: "measurement"
    accuracy_decimals: 2
    update_interval: 2s
    web_server:
        sorting_group_id: group_heating
    lambda: |-
      int new_source = 0;
      const uint32_t HA_STABLE_TIME = 10000; // 10 —Å–µ–∫—É–Ω–¥ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ

      // --- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ HA ---
      if (id(thermostat_status).state &&
          id(in_temp_from_ha).has_state() &&
          isfinite(id(in_temp_from_ha).state)) {
          
        if (id(ha_stable_since) == 0) {
          id(ha_stable_since) = millis();
        }

        if (millis() - id(ha_stable_since) >= HA_STABLE_TIME) {
          new_source = 1; // HA
        }

      } else {
        id(ha_stable_since) = 0;
      }

      // --- Fallback –Ω–∞ BME ---
      if (new_source == 0 &&
          id(bme280_temperature).has_state() &&
          isfinite(id(bme280_temperature).state)) {
        new_source = 2; // BME
      }

      // --- Logging of switching ---
      if (new_source != id(temp_source)) {
        if (new_source == 1) {
          ESP_LOGI("temp", "Temperature source switched to HOME ASSISTANT");
        } else if (new_source == 2) {
          ESP_LOGW("temp", "Temperature source switched to BME280");
        } else {
          ESP_LOGE("temp", "No valid temperature source available");
        }
        id(temp_source) = new_source;
      }

      // --- –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω–Ω—è ---
      float result = NAN; // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–º—ñ–Ω–Ω—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
      if (new_source == 1) {
        result = id(in_temp_from_ha).state;
      } else if (new_source == 2) {
        result = id(bme280_temperature).state;
      }

      // --- –ê–¥–∞–ø—Ç–∏–≤–Ω–µ –ï–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è ---
      if (id(night_mode).state && !std::isnan(result)) {
        result += id(eco_offset); // PID "–¥—É–º–∞—î", —â–æ –≤ —Ö–∞—Ç—ñ —Ç–µ–ø–ª—ñ—à–µ, —ñ –º'—è–∫–æ –∑–Ω–∏–∂—É—î –Ω–∞–≥—Ä—ñ–≤
      }
      
      return result;

  - platform: template
    name: "Equithermic Target Temperature"
    id: equitherm_t_set
    unit_of_measurement: "¬∞C"
    icon: "mdi:chart-bell-curve-cumulative"
    lambda: |-
      float to = id(t_outside_ha).state; // –í—É–ª–∏—á–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞

      // –Ø–∫—â–æ –ø–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è NaN (unknown), –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–µ—à
      // If the current value is NaN (unknown), check the cache
      if (std::isnan(to)) {
        uint32_t cache_age = millis() - id(last_outside_update_ms);
        
        // –Ø–∫—â–æ –∫–µ—à —Å–≤—ñ–∂–∏–π (–º–µ–Ω—à–µ 2 –≥–æ–¥–∏–Ω = 7,200,000 –º—Å)
        // If the cache is fresh (less than 2 hours = 7,200,000 ms)
        if (id(last_outside_update_ms) > 0 && cache_age < 7200000) {
          to = id(last_valid_outside_temp);
          ESP_LOGD("equitherm", "Using cached outdoor temp: %.1f (Age: %u s)", to, cache_age / 1000);
        } else {
          // –Ø–∫—â–æ –∫–µ—à –∑–∞—Å—Ç–∞—Ä–∏–π –∞–±–æ –π–æ–≥–æ –Ω–µ–º–∞—î, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∞–≤–∞—Ä—ñ–π–Ω–∏–π fallback
          // If the cache is outdated or missing, we use an emergency fallback
          ESP_LOGW("equitherm", "Outdoor temp cache expired or empty. Using fallback 50C");
          return 50.0; 
        }
      }

      float tr = id(pid_calculated_target).state; // –¶—ñ–ª—å–æ–≤–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –∫—ñ–º–Ω–∞—Ç—ñ
      // float k = 1.2;   // –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –∫—Ä–∏–≤–æ—ó (–º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –≤ globals)
      // --- –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø–æ–≥–æ–¥–Ω–æ—ó –∫—Ä–∏–≤–æ—ó ---
      float k;
      if (to <= -10.0)      k = 1.30;
      else if (to <= 0.0)   k = 1.15;
      else if (to <= 5.0)   k = 1.00;
      else                  k = 0.85;

      if (std::isnan(to)) return 50.0; // Fallback: —è–∫—â–æ HA –Ω–µ –ø–µ—Ä–µ–¥–∞–≤ –¥–∞–Ω—ñ, —Å—Ç–∞–≤–∏–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ 40¬∞C

      // –ö–ª–∞—Å–∏—á–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –æ–ø–∞–ª—é–≤–∞–ª—å–Ω–æ—ó –∫—Ä–∏–≤–æ—ó
      float t_water = tr + k * (tr - to); 

      // –û–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è Bosch Gaz 6000 W (–¥—ñ–∞–ø–∞–∑–æ–Ω 40-82¬∞C)
      if (t_water > 80.0) t_water = 80.0;
      if (t_water < 40.0) t_water = 40.0;

      return t_water;
    update_interval: 60s

  # Adding a BME280 sensor
  - platform: bme280_i2c
    temperature:
      name: "BME280 Temperature"
      id: bme280_temperature
      icon: mdi:thermometer
      web_server:
        sorting_group_id: group_temperature
    pressure:
      name: "BME280 Pressure"
      id: bme280_pressure
      icon: mdi:gauge
      web_server:
        sorting_group_id: group_temperature
    humidity:
      name: "BME280 Humidity"
      id: bme280_humidity
      icon: mdi:water-percent
      web_server:
        sorting_group_id: group_temperature
    address: 0x76
    update_interval: 30s

  - platform: template
    name: "–¶—ñ–ª—å–æ–≤–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è (PID)"
    id: pid_calculated_target
    unit_of_measurement: "¬∞C"
    accuracy_decimals: 1
    web_server:
        sorting_group_id: group_heating
    icon: "mdi:thermometer-lines"
    lambda: |-
      // –û—Å–∫—ñ–ª—å–∫–∏ ch_setpoint —É–∂–µ –ø–æ–≤–µ—Ä—Ç–∞—î –≥—Ä–∞–¥—É—Å–∏, –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º–æ –π–æ–≥–æ —Å—Ç–∞–Ω
      float target = id(ch_setpoint).state;
      
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤–∏–º–∫–Ω–µ–Ω–∏–π —Å—Ç–∞–Ω (—è–∫—â–æ zero_means_zero: true)
      if (target <= 0.0) return 0.0;
      
      return target;
    update_interval: 10s

  - platform: template
    name: "–í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏"
    id: temp_deviation
    unit_of_measurement: "¬∞C"
    accuracy_decimals: 2
    web_server:
        sorting_group_id: group_heating
    icon: mdi:delta
    lambda: |-
      // –û—Ç—Ä–∏–º—É—î–º–æ —Ü—ñ–ª—å–æ–≤—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑ –∫–ª—ñ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞
      float target = id(ch_climate).target_temperature;
      
      // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑ –≤–∞—à–æ–≥–æ "—Ä–æ–∑—É–º–Ω–æ–≥–æ" —Å–µ–Ω—Å–æ—Ä–∞
      float current = id(smart_room_temperature).state;
      
      // –Ø–∫—â–æ –¥–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ NAN
      if (std::isnan(current) || std::isnan(target)) {
        return NAN;
      }
      
      // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —Ä—ñ–∑–Ω–∏—Ü—é
      return target - current;
    update_interval: 5s

text_sensor:
  - platform: template
    name: "Last Timeout Message"
    icon: mdi:math-log
    id: last_timeout_msg

  - platform: template
    name: "–ë—É–¥–∏–Ω–æ–∫: –°—Ç–∞—Ç—É—Å —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤"
    id: calculation_status
    icon: mdi:database-sync-outline
    web_server:
      sorting_group_id: group_calculation

  - platform: template
    name: "Loop time state"
    icon: mdi:speedometer
    lambda: |-
      float val = id(loop_time).state;
      if (val < 10.0) return {"Fast"};
      if (val < 50.0) return {"Normal"};
      if (val < 100.0) return {"Long"};
      if (val < 200.0) return {"Too Long"};
      return {"Critical"};
    update_interval: 10s
    web_server:
      sorting_group_id: group_status

  # Thermostat operating time since last reset
  - platform: template
    name: "Uptime"
    icon: mdi:clock-outline
    entity_category: diagnostic
    update_interval: 10s
    web_server:
      sorting_group_id: group_status
    lambda: |-
      uint32_t s = (uint32_t) id(uptime_sec).state;

      uint32_t days = s / 86400;
      uint32_t hours = (s % 86400) / 3600;
      uint32_t minutes = (s % 3600) / 60;
      uint32_t seconds = s % 60;

      char buffer[32];
      snprintf(buffer, sizeof(buffer),
               "%u –¥–Ω. %02u:%02u:%02u",
               days, hours, minutes, seconds);
      return std::string{buffer};

  - platform: wifi_info
    ssid:
      name: "WiFi SSID"
      icon: mdi:wifi-check
      web_server:
        sorting_group_id: group_wifi
    ip_address:
      name: "WiFi IP Address"
      icon: mdi:wifi-settings
      web_server:
        sorting_group_id: group_wifi
    bssid:
      name: "WiFi BSSID"
      icon: mdi:wifi-cog
      web_server:
        sorting_group_id: group_wifi

# Use PID Climate component for automatic boiler setpoint calculation
# https://esphome.io/components/climate/pid
climate:
  - platform: pid
    id: ch_climate
    name: "Heating Climate"
    icon: mdi:thermostat-auto
    web_server:
      sorting_group_id: group_heating
    heat_output: ch_setpoint
    default_target_temperature: 21
    sensor: smart_room_temperature
    visual:
      min_temperature: 19
      max_temperature: 24
      temperature_step:
        target_temperature: 0.1
        current_temperature: 0.1
    control_parameters: 
      kp: 0.4
      ki: 0.002
      kd: 0
      output_averaging_samples: 60
    deadband_parameters:
      threshold_high: 0.5
      threshold_low: -0.3
      kp_multiplier: 0.4
      ki_multiplier: 0.15
      kd_multiplier: 0.0
      deadband_output_averaging_samples: 40
    on_state:
      - lambda: |-
          // 1. –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∂–∏–≤–ª–µ–Ω–Ω—è–º –∫–æ—Ç–ª–∞
          if (x.mode == CLIMATE_MODE_OFF) {
            id(ch_enable).turn_off();
          } else {
            id(ch_enable).turn_on();
            // –ó–ê–ü–£–°–ö–ê–¢–ò –¢–Ü–õ–¨–ö–ò –Ø–ö–©–û –°–ö–†–ò–ü–¢ –©–ï –ù–ï –ü–†–ê–¶–Æ–Ñ
            if (id(flame_on).state && !id(measure_heating).is_running()) {
              id(measure_heating).execute();
            }
          }

          // 2. –î–∏–Ω–∞–º—ñ—á–Ω–∏–π PID (–ú'—è–∫—à—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –≤–Ω–æ—á—ñ)
          if (id(night_mode).state) {
              // –ó–ê–ú–Ü–°–¢–¨ id(ch_climate).set_control_parameters(0.35, 0.001, 0.0);
              id(ch_climate).set_kp(0.35); 
              id(ch_climate).set_ki(0.001);
              id(ch_climate).set_kd(0.0);
          } else {
              // –ó–ê–ú–Ü–°–¢–¨ id(ch_climate).set_control_parameters(0.4, 0.002, 0.0);
              id(ch_climate).set_kp(0.45);
              id(ch_climate).set_ki(0.0015);
              id(ch_climate).set_kd(0.0);
          }

          // 3. –î–∏–Ω–∞–º—ñ—á–Ω–µ –æ–±–º–µ–∂–µ–Ω–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Ç–µ–ø–ª–æ–Ω–æ—Å—ñ—è
          float cap = id(equitherm_t_set).state; // –ë–µ—Ä–µ–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –ø–æ–≥–æ–¥–Ω–æ—ó –∫—Ä–∏–≤–æ—ó
          
          if (id(night_mode).state) {
            cap -= 8.0; // –í–Ω–æ—á—ñ –¥–æ–¥–∞—Ç–∫–æ–≤–æ –æ–±–º–µ–∂—É—î–º–æ –≤–æ–¥—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–µ –≤–∏—â–µ 45-48¬∞C)
          }
          
          // –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –º—ñ–Ω—ñ–º—É–º Bosch Gaz 6000 W
          if (cap < 40.0) cap = 40.0; 

          // –ü—Ä–∏–º—É—Å–æ–≤–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –≤–∏—Ö–æ–¥—É PID
          if (id(ch_setpoint).state > cap) {
            id(ch_setpoint).set_level(cap);
          }

          // 4. –õ–æ–≥—É–≤–∞–Ω–Ω—è
          ESP_LOGI("climate", "Target: %.1f, Water: %.1f %s", 
                   x.target_temperature, id(ch_setpoint).state,
                   id(night_mode).state ? "(NIGHT MODE)" : "");

# [UA] –ë–ª–æ–∫ —Å–∫—Ä–∏–ø—Ç—ñ–≤ –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∫–ª–∞–¥–Ω–æ—ó –ª–æ–≥—ñ–∫–∏ —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤
# [EN] Script block for implementing complex self-learning logic and calculations
script:
  # [UA] –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –±—É–¥–∏–Ω–∫—É (–ø–∞—Å–∏–≤–Ω–∞ —ñ–Ω–µ—Ä—Ü—ñ—è)
  # [UA] –ü—Ä–∞—Ü—é—î 45 —Ö–≤–∏–ª–∏–Ω –ø—Ä–∏ –≤–∏–º–∫–Ω–µ–Ω–æ–º—É –ø–∞–ª—å–Ω–∏–∫—É –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è "—á–∏—Å—Ç–æ–≥–æ" —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
  # [EN] Measuring house cooling rate (passive inertia)
  # [EN] Runs for 45 minutes with the burner off to get a "clean" result
  - id: measure_cooling
    mode: restart
    then:
      - lambda: |-
          ESP_LOGI("measure_cooling", "–û—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è. –ü–æ—á–∞—Ç–æ–∫ –∑–∞–º—ñ—Ä—É —ñ–Ω–µ—Ä—Ü—ñ—ó (45 —Ö–≤)...");
          // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –û–î–†–ê–ó–£ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ:
          id(calculation_status).publish_state("–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è (—Ç—Ä–∏–≤–∞—î 45 —Ö–≤)");
          id(temp_sample_start) = id(smart_room_temperature).state;
          id(sample_time_start) = millis();
      - delay: 45min
      - lambda: |-
          // [UA] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —è–∫—â–æ –∑–∞ —Ü–µ–π —á–∞—Å –∫–æ—Ç–µ–ª –≤–º–∏–∫–∞–≤—Å—è, –∑–∞–º—ñ—Ä –≤–≤–∞–∂–∞—î—Ç—å—Å—è –Ω–µ—Ç–æ—á–Ω–∏–º
          // [EN] Check: if the boiler turned on during this time, the measurement is considered inaccurate
          if (id(flame_on).state) {
            id(calculation_status).publish_state("–û—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ—Ä–≤–∞–Ω–æ (–≤–º–∏–∫–∞–≤—Å—è –∫–æ—Ç–µ–ª)");
            return;
          }

          float dt = (millis() - id(sample_time_start)) / 3600000.0;
          if (dt < 0.2) return;

          float rate = (id(temp_sample_start) - id(smart_room_temperature).state) / dt;

          // [UA] –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó –∑ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é (0.7/0.3)
          // [EN] Result validation and global variable update with filtering (0.7/0.3)
          if (rate > 0 && rate < 2.0) {
            id(cooling_rate) = id(cooling_rate) * 0.7 + rate * 0.3;
            id(calculation_status).publish_state("–û—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –≤–∏–º—ñ—Ä—è–Ω–æ —É—Å–ø—ñ—à–Ω–æ");
            id(cooling_rate_ui).publish_state(id(cooling_rate)); 
            ESP_LOGI("measure_cooling", "New cooling rate: %.2f ¬∞C/h", id(cooling_rate));
          } else {
            id(calculation_status).publish_state("–ó–∞–º—ñ—Ä –Ω–µ—Ç–æ—á–Ω–∏–π (–¢ –Ω–µ –≤–ø–∞–ª–∞)");
          }

  # [UA] –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –Ω–∞–≥—Ä—ñ–≤—É –±—É–¥–∏–Ω–∫—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ñ–π —Ä–æ–±–æ—Ç—ñ –ø–∞–ª—å–Ω–∏–∫–∞
  # [EN] Measuring house heating rate during active burner operation
  - id: measure_heating
    mode: restart
    then:
      - lambda: |-
          // Notification of the start of the heating rate measurement process (log and sensor)
          id(calculation_status).publish_state("Heating measurement (lasts 30 min)");
          ESP_LOGI("measure_heating", "Heating measurement (lasts 30 min)");
          
          id(temp_sample_start) = id(smart_room_temperature).state;
          id(sample_time_start) = millis();
      - delay: 30min
      - lambda: |-
          // [UA] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–¥—É–ª—è—Ü—ñ—ó: –Ω–∞–≥—Ä—ñ–≤ —Ä–∞—Ö—É—î—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ > 20%
          // [EN] Modulation check: heating is only calculated if power > 20%
          if (!id(flame_on).state || id(rel_mod_level).state < 20) {
            id(calculation_status).publish_state("Heating interrupted (low power)");
            ESP_LOGI("measure_heating", "Heating interrupted (low power)");
            return;
          }

          float dt = (millis() - id(sample_time_start)) / 3600000.0;
          if (dt < 0.2) return;

          float rate = (id(smart_room_temperature).state - id(temp_sample_start)) / dt;

          if (rate > 0 && rate <= 3.0) {
            id(heating_rate) = id(heating_rate) * 0.7 + rate * 0.3;
            id(calculation_status).publish_state("New heating rate calculated");
            id(heating_rate_ui).publish_state(id(heating_rate));
            
            ESP_LOGI("measure_heating", "New heating rate calculated: %.2f ¬∞C/h", id(heating_rate));
          } else {
            ESP_LOGI("measure_heating", "The measurement is inaccurate (no T growth)");
            id(calculation_status).publish_state("The measurement is inaccurate (no T growth))");
          }

  # [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –µ–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è (offset) –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–æ—ó —ñ–Ω–µ—Ä—Ü—ñ—ó
  # [EN] Calculation of adaptive eco-offset based on current inertia
  - id: calculate_eco
    mode: restart
    then:
      - lambda: |-
          // –Ø–∫—â–æ –Ω—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º –≤–∏–º–∫–Ω–µ–Ω–æ, —Å–∫–∏–¥–∞—î–º–æ –∑–º—ñ—â–µ–Ω–Ω—è
          if (!id(night_mode).state) { 
            id(eco_offset) = 0.0;
            id(eco_offset_ui).publish_state(0.0);
            return; 
          }

          // [UA] –§–æ—Ä–º—É–ª–∞: —à–≤–∏–¥–∫—ñ—Å—Ç—å –æ—Å—Ç–∏–≥–∞–Ω–Ω—è * —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –Ω–æ—á—ñ * –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è
          // [EN] Formula: cooling rate * night duration * self-learning gain
          float offset = id(cooling_rate) * id(night_duration_hours) * id(eco_gain);

          // –û–±–º–µ–∂–µ–Ω–Ω—è (clamp), —â–æ–± –±—É–¥–∏–Ω–æ–∫ –Ω–µ –≤–∏—Ö–æ–ª–æ–¥–∏–≤—Å—è –±—ñ–ª—å—à–µ –Ω—ñ–∂ –Ω–∞ 1.5¬∞C
          id(eco_offset) = clamp(offset, 0.3f, 1.5f); 
          
          // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Home Assistant
          id(eco_offset_ui).publish_state(id(eco_offset));
          id(calculation_status).publish_state("–ï–∫–æ-–∑–º—ñ—â–µ–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ");
          
          ESP_LOGI("calculate_eco", "Calculated adaptive offset: %.2f ¬∞C", id(eco_offset));

  # [UA] –°–∫—Ä–∏–ø—Ç —Å–∞–º–æ–Ω–∞–≤—á–∞–Ω–Ω—è: —â–æ—Ä–∞–Ω–∫—É –∫–æ—Ä–∏–≥—É—î eco_gain –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ö–∏–±–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏
  # [EN] Self-learning script: adjusts eco_gain every morning based on temperature error
  - id: eco_self_learning
    mode: restart
    then:
      - lambda: |-
          float error = id(morning_temp) - id(ch_climate).target_temperature;

          // –•–æ–ª–æ–¥–Ω–æ ‚Üí eco –±—É–≤ –∑–∞–≤–µ–ª–∏–∫–∏–π
          if (error < -0.3) {
            id(eco_gain) -= 0.05;
          }
          // –ó–∞–Ω–∞–¥—Ç–æ —Ç–µ–ø–ª–æ ‚Üí –º–æ–∂–Ω–∞ –µ–∫–æ–Ω–æ–º–∏—Ç–∏ –±—ñ–ª—å—à–µ
          else if (error > 0.3) {
            id(eco_gain) += 0.05;
          }

          id(eco_gain) = clamp(id(eco_gain), 0.6f, 0.9f);

  # [UA] –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –Ω–æ—á—ñ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è —Ç–µ–ø–ª–æ–≤—Ç—Ä–∞—Ç
  # [EN] Night duration calculation for predicting heat loss
  - id: calc_night_duration
    mode: restart
    then:
      - lambda: |-
          float start = id(night_start_hour).state;
          float end   = id(night_end_hour).state;

          float hours = (end >= start)
            ? (end - start)
            : (24.0 - start + end);

          id(night_duration_hours) = hours;